<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="./dist/output.css" rel="stylesheet">
    <script src="./node_modules/flowbite/dist/flowbite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }

        /* Table styles */
        .student-table th {
            position: relative;
        }

        .sortable {
            cursor: pointer;
        }

        .sortable:after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.6;
        }

        .sortable.asc:after {
            content: '↑';
            opacity: 1;
        }

        .sortable.desc:after {
            content: '↓';
            opacity: 1;
        }

        /* Animations */
        .animate-pulse-soft {
            animation: pulse-soft 2s infinite;
        }
        
        @keyframes pulse-soft {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }

        /* Custom styles that can't be achieved with Tailwind */
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Sidebar styles */
        .sidebar {
            transition: all 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 40;
            overflow-y: auto;
        }

        .sidebar:hover {
            width: 256px !important;
            min-width: 256px !important;
            max-width: 256px !important;
        }

        .sidebar:not(:hover) {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
        }

        .sidebar:not(:hover) .nav-text,
        .sidebar:not(:hover) .welcome-text,
        .sidebar:not(:hover) .footer-text {
            display: none;
        }

        .sidebar:not(:hover) .nav-icon {
            margin-right: 0;
        }

        .sidebar:not(:hover) .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar:not(:hover) .profile-section {
            padding: 0.5rem;
        }

        .sidebar:not(:hover) .profile-image {
            width: 40px;
            height: 40px;
        }

        .sidebar:not(:hover) .footer-section {
            padding: 0.5rem;
        }

        /* Add styles for main content to account for fixed sidebar */
        main {
            margin-left: 80px;
            transition: margin-left 0.3s ease;
        }

        .sidebar:hover + main {
            margin-left: 256px;
        }

        /* Fix icon positioning */
        .nav-item {
            display: flex;
            align-items: center;
            position: relative;
        }

        .nav-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }

        /* Remove burger menu styles since we're using hover */
        .burger-menu,
        .burger-icon {
            display: none;
        }
    </style>
</head>
<body class="bg-secondary-50 font-sans text-base text-secondary-600 relative antialiased">
    <div class="fixed top-0 right-0 z-50 flex gap-2 select-none p-2">
        <button onclick="window.electronAPI.minimize()" title="Minimize" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-blue-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 18L18 18"/></svg>
        </button>
        <button onclick="window.electronAPI.maximize()" title="Maximize/Restore" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-green-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="6" y="6" width="12" height="12" rx="2" stroke-width="2"/></svg>
        </button>
        <button onclick="window.electronAPI.close()" title="Close" class="w-8 h-8 flex items-center justify-center rounded hover:bg-red-100 active:bg-red-200 text-gray-600 hover:text-red-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 6l12 12M6 18L18 6"/></svg>
        </button>
    </div>
    <div class="flex min-h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar bg-gray-100 w-64 min-w-[256px] max-w-[256px] flex flex-col py-6 px-3 select-none shrink-0 shadow-xl z-10 border-r border-gray-200 relative">
            <div class="flex flex-col items-center space-y-3 mb-8 profile-section">
                <div class="relative group">
                    <div class="absolute inset-0 bg-primary-100 rounded-full opacity-70 blur-md transform group-hover:scale-110 transition-all duration-300"></div>
                    <div class="relative bg-white rounded-full w-16 h-16 flex items-center justify-center shadow-md profile-image">
                        <img alt="Admin" class="rounded-full w-12 h-12 object-cover" src="assets/pic/removebgroyal.png"/>
                    </div>
                </div>
                <div class="text-center welcome-text">
                    <p class="text-xs font-bold uppercase tracking-wider mb-1 text-gray-500">Welcome</p>
                    <p class="text-lg font-bold text-gray-800">ADMIN</p>
                </div>
            </div>
            
            <nav class="w-full flex flex-col space-y-1 font-medium text-sm mt-2">
                <button onclick="window.location.href='admindashboard.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-chart-line w-5 text-center nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </button>
                
                <button id="members-menu" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg bg-primary-100 text-primary-700 font-semibold transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-users w-5 text-center nav-icon"></i>
                    <span class="nav-text">Students</span>
                </button>
                
                <button onclick="window.location.href='adminbookmodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-book w-5 text-center nav-icon"></i>
                    <span class="nav-text">Books</span>
                </button>
                
                <button onclick="window.location.href='adminhistorymodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-history w-5 text-center nav-icon"></i>
                    <span class="nav-text">History</span>
                </button>
                
                <button onclick="window.location.href='borrowed.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-hand-holding w-5 text-center nav-icon"></i>
                    <span class="nav-text">Borrow Book</span>
                </button>
                
                <button onclick="window.location.href='returned.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-undo w-5 text-center nav-icon"></i>
                    <span class="nav-text">Return Book</span>
                </button>
                
                <button onclick="window.location.href='rewards.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-trophy w-5 text-center nav-icon"></i>
                    <span class="nav-text">Rewards</span>
                </button>

                <button onclick="window.location.href='archive.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-archive w-5 text-center nav-icon"></i>
                    <span class="nav-text">Archive</span>
                </button>
                
                <div class="border-t border-gray-300 my-2 px-3"></div>
                
                <button onclick="logout()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-100 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-sign-out-alt w-5 text-center nav-icon"></i>
                    <span class="nav-text">Log Out</span>
                </button>
            </nav>
            
            <div class="mt-auto px-4 py-4 footer-section">
                <div class="bg-primary-50 border border-primary-100 rounded-lg px-3 py-2 text-xs text-gray-700 footer-text">
                    <p class="mb-1 font-medium text-gray-800">Royal Heirs Academy</p>
                    <p>Library Management System</p>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-x-auto bg-secondary-50">
            <div class="container mx-auto px-4 py-6">
                <!-- Header Section -->
                <header class="mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-secondary-900 leading-tight">
                                Student Management
                            </h1>
                            <p class="mt-1 text-sm text-secondary-500">Manage student records and information</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0 flex flex-wrap gap-2">
                            <button onclick="exportToExcel()" class="px-3 py-1.5 bg-primary-600 text-white rounded-lg shadow hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all flex items-center text-sm">
                                <i class="fas fa-file-excel mr-2"></i>
                                <span>Export to Excel</span>
                            </button>
                            <button onclick="document.getElementById('importExcel').click()" class="px-3 py-1.5 bg-primary-600 text-white rounded-lg shadow hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all flex items-center text-sm">
                                <i class="fas fa-file-import mr-2"></i>
                                <span>Import from Excel</span>
                            </button>
                            <button onclick="downloadImportTemplate()" class="text-primary-600 hover:text-primary-700 underline flex items-center text-xs">
                                <i class="fas fa-download mr-1"></i>
                                <span>Download Template</span>
                            </button>
                            <input type="file" id="importExcel" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
                        </div>
                    </div>
                </header>

                <!-- Action Bar -->
                <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex flex-wrap items-center justify-between gap-3 border border-secondary-100">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="addStudent()" class="px-3 py-1.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center text-sm">
                            <i class="fas fa-user-plus mr-2"></i>
                            <span>Add Student</span>
                        </button>
                        <button id="openDeleteModal-btn" class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center text-sm">
                            <i class="fas fa-user-minus mr-2"></i>
                            <span>Delete Student</span>
                        </button>
                        <button id="deleteSelectedStudents-btn" class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center text-sm hidden">
                            <i class="fas fa-user-minus mr-2"></i>
                            <span>Delete Selected</span>
                        </button>
                    </div>
                    <div class="relative flex items-center space-x-2">
                        <select 
                            id="searchColumn" 
                            class="px-2 py-1.5 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white text-sm"
                            onchange="searchStudents()">
                            <option value="all">All Columns</option>
                            <option value="id">ID</option>
                            <option value="name">Name</option>
                            <option value="username">Username</option>
                            <option value="cellphone">Phone</option>
                            <option value="email">Email</option>
                        </select>
                        <div class="relative">
                            <i class="fas fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-secondary-400 text-sm"></i>
                            <input 
                                class="pl-8 pr-3 py-1.5 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 w-48 text-sm" 
                                type="text" 
                                id="studentSearch" 
                                placeholder="Search students..." 
                                oninput="searchStudents()">
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-secondary-100">
                    <div class="overflow-x-auto">
                        <table class="student-table w-full border-collapse text-sm">
                            <thead>
                                <tr class="bg-secondary-100 text-secondary-700">
                                    <th class="p-2 text-left font-semibold">
                                        <input type="checkbox" id="selectAllStudents" class="w-3.5 h-3.5 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500">
                                    </th>
                                    <th class="p-2 text-left font-semibold">ID</th>
                                    <th class="p-2 text-left font-semibold">Name</th>
                                    <th class="p-2 text-left font-semibold">Username</th>
                                    <th class="p-2 text-left font-semibold">Phone</th>
                                    <th class="p-2 text-left font-semibold">Password</th>
                                    <th class="p-2 text-left font-semibold w-32">Email</th>
                                    <th class="p-2 text-left font-semibold">Points</th>
                                    <th class="p-2 text-left font-semibold w-24">QR Code</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-secondary-100">
                                <!-- Student data will be populated here -->
                                <tr>
                                    <td colspan="9" class="p-4 text-center text-secondary-500">
                                        <div class="py-6">
                                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600 mb-3"></div>
                                            <p class="text-sm">Loading students...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addStudentModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-secondary-900">Add Student</h2>
                <button onclick="closeModal()" class="text-secondary-400 hover:text-secondary-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="studentForms" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <div class="student-form border border-secondary-200 p-4 rounded-lg bg-secondary-50">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-1">Full Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="name_0" name="name" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-1">Username</label>
                            <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="username_0" name="username" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-1">Password</label>
                            <input type="password" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="password_0" name="password" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-1">Cellphone Number</label>
                            <div class="flex">
                                <span class="px-3 py-2 bg-secondary-100 border border-secondary-300 border-r-0 rounded-l-lg text-secondary-600">+639</span>
                                <input type="text" 
                                    class="w-full px-3 py-2 border border-secondary-300 border-l-0 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                    id="cellphone_0" 
                                    name="cellphone" 
                                    required 
                                    pattern="[0-9]{9}"
                                    maxlength="9"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                    placeholder="Enter 9 digits"
                                    title="Please enter 9 digits after +639">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                            <input type="email" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="email_0" name="email" placeholder="student@example.com">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between mt-6">
                <button type="button" onclick="addMoreStudentFields()" class="px-4 py-2 bg-secondary-100 text-secondary-700 rounded-lg hover:bg-secondary-200 transition-colors flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    <span>Add Another</span>
                </button>
                <button type="button" onclick="submitStudents()" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    <span>Save Students</span>
                </button>
            </div>
        </div>
    </div>

    <div id="deleteStudentModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-secondary-900">Delete Student</h2>
                <button id="closeDeleteModal" class="text-secondary-400 hover:text-secondary-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <p class="text-secondary-600 mb-4">Enter student ID or name to delete the record. This action cannot be undone.</p>
            
            <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mb-4" id="deleteStudentId" placeholder="Enter Student ID or Name" required>
            
            <button onclick="deleteStudent()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                <i class="fas fa-trash-alt mr-2"></i>
                <span>Delete Student</span>
            </button>
        </div>
    </div>

    <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4 success">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <p id="modalMessage" class="text-lg font-semibold"></p>
            </div>
        </div>
    </div>

    <div id="importConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-secondary-900">Confirm Import</h2>
                <button onclick="closeImportConfirmModal()" class="text-secondary-400 hover:text-secondary-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="importConfirmMessage" class="text-secondary-700 mb-6"></div>
            <div class="flex justify-end space-x-4">
                <button onclick="closeImportConfirmModal()" class="px-4 py-2 bg-secondary-100 text-secondary-700 rounded-lg hover:bg-secondary-200 transition-colors">Cancel</button>
                <button id="confirmImportBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">Import</button>
            </div>
        </div>
    </div>

    <script>
    const API_BASE_URL = "http://localhost:5000/api/students";
    let storedStudentData = [];
    let studentFormCount = 1;
    let currentPage = 1;
    let studentsPerPage = 5;
    let selectedStudentIds = new Set();
    let isSelectAllChecked = false;

    // Function to fetch students
    async function fetchStudents() {
        try {
            const tableBody = document.querySelector(".student-table tbody");
            
            // Show loading indicator
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="p-4 text-center text-secondary-500">
                        <div class="py-6">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600 mb-3"></div>
                            <p class="text-sm">Loading students...</p>
                        </div>
                    </td>
                </tr>
            `;
            
            const response = await fetch(API_BASE_URL);
            
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            
            const students = await response.json();
            storedStudentData = students;
            renderStudentsTable();
        } catch (error) {
            console.error("Error fetching students:", error);
            showModal('Error fetching students: ' + error.message, 'error');
            
            const tableBody = document.querySelector(".student-table tbody");
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="p-4 text-center text-red-500">
                        <div class="py-8">
                            <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Unable to load students</p>
                            <p class="text-sm mt-2">Please check your connection and try again</p>
                            <button onclick="fetchStudents()" class="mt-4 px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                                Try Again
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // Function to render students table with pagination
    function renderStudentsTable(filteredStudents = storedStudentData) {
        const tableBody = document.querySelector(".student-table tbody");
        
        // Remove any existing pagination controls
        const existingPagination = document.querySelector('.pagination-controls');
        if (existingPagination) {
            existingPagination.remove();
        }

        // Sort students by the last 4 digits of their ID
        filteredStudents.sort((a, b) => {
            const aId = a.id ? parseInt(a.id.split('-')[1]) : 0;
            const bId = b.id ? parseInt(b.id.split('-')[1]) : 0;
            return aId - bId;
        });

        // Calculate pagination values
        const totalStudents = filteredStudents.length;
        const totalPages = Math.ceil(totalStudents / studentsPerPage);
        const startIndex = (currentPage - 1) * studentsPerPage;
        const endIndex = Math.min(startIndex + studentsPerPage, totalStudents);
        const currentStudents = filteredStudents.slice(startIndex, endIndex);

        // Create pagination controls
        const paginationControls = document.createElement('div');
        paginationControls.className = 'pagination-controls flex justify-between items-center my-4 text-sm text-secondary-600';
        paginationControls.innerHTML = `
            <div class="flex items-center space-x-3">
                <span class="text-xs font-medium bg-primary-50 text-primary-700 px-2.5 py-1 rounded-full">
                    ${totalStudents === 0 ? '0-0' : `${startIndex + 1}-${endIndex}`} of ${totalStudents}
                </span>
                <button id="prev-page" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 transition-all ${currentPage === 1 ? 'opacity-50 cursor-not-allowed text-secondary-400' : 'text-secondary-700'}" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="font-medium">Page ${currentPage} of ${totalPages || 1}</span>
                <button id="next-page" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 transition-all ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed text-secondary-400' : 'text-secondary-700'}" ${currentPage >= totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div>
                <select id="rows-per-page" class="text-sm border-secondary-200 rounded-lg focus:border-primary-500 focus:ring focus:ring-primary-200 focus:ring-opacity-50 bg-white shadow-sm">
                    <option value="5" ${studentsPerPage === 5 ? 'selected' : ''}>5 rows</option>
                    <option value="10" ${studentsPerPage === 10 ? 'selected' : ''}>10 rows</option>
                    <option value="25" ${studentsPerPage === 25 ? 'selected' : ''}>25 rows</option>
                </select>
            </div>
        `;

        // Insert pagination controls after the table
        const table = document.querySelector(".student-table").closest('.bg-white');
        table.insertAdjacentElement('afterend', paginationControls);

        // Clear the table body
        tableBody.innerHTML = '';

        // Render the current page of students
        if (currentStudents.length === 0) {
            const searchText = document.getElementById('studentSearch').value;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="p-4 text-center text-secondary-500">
                        <div class="py-8">
                            <i class="fas fa-search text-secondary-300 text-4xl mb-4"></i>
                            <p class="text-lg font-medium">No results found</p>
                            ${searchText ? `<p class="text-sm mt-2">No students matching "${searchText}" found</p>` : ''}
                            ${searchText ? `<button onclick="document.getElementById('studentSearch').value = ''; searchStudents();" class="mt-4 px-4 py-2 bg-secondary-100 text-secondary-700 rounded-lg hover:bg-secondary-200 transition-colors">Clear Search</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        } else {
            currentStudents.forEach((student) => {
                const row = document.createElement("tr");
                row.className = "hover:bg-secondary-50 transition-colors";
                row.innerHTML = `
                    <td class="p-2">
                        <input type="checkbox" class="student-checkbox w-3.5 h-3.5 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500" data-student-id="${student.id}" ${selectedStudentIds.has(student.id) ? 'checked' : ''}>
                    </td>
                    <td class="p-2 whitespace-nowrap">${student.id || 'N/A'}</td>
                    <td class="p-2 font-medium text-secondary-900">${student.name}</td>
                    <td class="p-2">${student.username}</td>
                    <td class="p-2">${student.cellphone || 'N/A'}</td>
                    <td class="p-2">
                        <div class="flex items-center space-x-2">
                            <span class="password-field" data-password="${student.password || 'N/A'}">••••••••</span>
                            <button onclick="togglePassword(this)" class="text-secondary-500 hover:text-primary-600 transition-colors" title="Show/Hide Password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td class="p-2">
                        <div class="truncate max-w-[200px]" title="${student.email || 'N/A'}">${student.email || 'N/A'}</div>
                    </td>
                    <td class="p-2">
                        <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-medium bg-primary-50 text-primary-700">
                            ${student.points || 0} pts
                        </span>
                    </td>
                    <td class="p-2">
                        ${student.qr_code ? `<img src="${student.qr_code}" alt="QR Code" class="w-20 h-20 object-contain">` : 'No QR Code'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Add event listeners for pagination buttons
        document.getElementById('prev-page')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderStudentsTable(filteredStudents);
            }
        });

        document.getElementById('next-page')?.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderStudentsTable(filteredStudents);
            }
        });

        // Add event listener for rows per page selector
        document.getElementById('rows-per-page')?.addEventListener('change', (e) => {
            studentsPerPage = parseInt(e.target.value);
            currentPage = 1; // Reset to first page
            renderStudentsTable(filteredStudents);
        });

        // Reattach checkbox event listeners and update delete selected button
        handleStudentCheckbox();
        updateDeleteSelectedButton();
    }

    // Function to add student
    function addStudent() {
        // Reset the form
        document.getElementById('studentForms').innerHTML = `
            <div class="student-form border border-secondary-200 p-4 rounded-lg bg-secondary-50">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Full Name</label>
                        <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="name_0" name="name" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Username</label>
                        <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="username_0" name="username" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Password</label>
                        <input type="password" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="password_0" name="password" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Cellphone Number</label>
                        <div class="flex">
                            <span class="px-3 py-2 bg-secondary-100 border border-secondary-300 border-r-0 rounded-l-lg text-secondary-600">+639</span>
                            <input type="text" 
                                class="w-full px-3 py-2 border border-secondary-300 border-l-0 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                id="cellphone_0" 
                                name="cellphone" 
                                required 
                                pattern="[0-9]{9}"
                                maxlength="9"
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                placeholder="Enter 9 digits"
                                title="Please enter 9 digits after +639">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                        <input type="email" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="email_0" name="email" placeholder="student@example.com">
                    </div>
                </div>
            </div>
        `;
        studentFormCount = 1;
        document.getElementById('addStudentModal').style.display = 'flex';
    }

    // Function to close modal
    function closeModal() {
        document.getElementById('addStudentModal').style.display = 'none';
    }

    // Function to add more student fields
    function addMoreStudentFields() {
        const container = document.getElementById('studentForms');
        const newForm = document.createElement('div');
        newForm.className = 'student-form border border-secondary-200 p-4 rounded-lg bg-secondary-50 relative';
        newForm.innerHTML = `
            <button type="button" class="absolute top-2 right-2 text-secondary-400 hover:text-secondary-600 focus:outline-none" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Full Name</label>
                    <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="name_${studentFormCount}" name="name" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Username</label>
                    <input type="text" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="username_${studentFormCount}" name="username" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Password</label>
                    <input type="password" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="password_${studentFormCount}" name="password" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Cellphone Number</label>
                    <div class="flex">
                        <span class="px-3 py-2 bg-secondary-100 border border-secondary-300 border-r-0 rounded-l-lg text-secondary-600">+639</span>
                        <input type="text" 
                            class="w-full px-3 py-2 border border-secondary-300 border-l-0 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            id="cellphone_${studentFormCount}" 
                            name="cellphone" 
                            required 
                            pattern="[0-9]{9}"
                            maxlength="9"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            placeholder="Enter 9 digits"
                            title="Please enter 9 digits after +639">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                    <input type="email" class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="email_${studentFormCount}" name="email" placeholder="student@example.com">
                </div>
            </div>
        `;
        container.appendChild(newForm);
        studentFormCount++;
    }

    // Function to prepare delete of student
    function prepareDeleteStudent(id, name) {
        document.getElementById('deleteStudentId').value = id;
        document.getElementById('deleteStudentModal').style.display = 'flex';
    }

    // Function to submit students
    async function submitStudents() {
        const studentForms = document.getElementsByClassName('student-form');
        const students = [];

        for (let form of studentForms) {
            const nameInput = form.querySelector('input[name="name"]');
            const usernameInput = form.querySelector('input[name="username"]');
            const passwordInput = form.querySelector('input[name="password"]');
            const cellphoneInput = form.querySelector('input[name="cellphone"]');
            const emailInput = form.querySelector('input[name="email"]');

            if (cellphoneInput.value.length !== 9) {
                showModal('Phone number must be exactly 9 digits after +639', 'error');
                return;
            }

            if (nameInput.value && usernameInput.value && passwordInput.value && cellphoneInput.value) {
                students.push({
                    name: nameInput.value,
                    username: usernameInput.value,
                    password: passwordInput.value,
                    cellphone: '+639' + cellphoneInput.value,
                    email: emailInput.value || null
                });
            }
        }

        if (students.length === 0) {
            showModal('Please fill in all required fields', 'warning');
            return;
        }

        try {
            // Show loading indicator
            const submitBtn = document.querySelector('button[onclick="submitStudents()"]');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Saving...</span>';
            submitBtn.disabled = true;
            
            // Process each student one by one
            let successCount = 0;
            let errorCount = 0;
            
            for (const student of students) {
                try {
                    const response = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(student)
                    });
                    
                    if (!response.ok) {
                        const result = await response.json();
                        throw new Error(result.error || 'Failed to add student');
                    }
                    
                    successCount++;
                } catch (error) {
                    console.error("Error adding student:", error);
                    errorCount++;
                }
            }
            
            // Reset button
            submitBtn.innerHTML = originalContent;
            submitBtn.disabled = false;
            
            if (successCount > 0) {
                fetchStudents();
                closeModal();
                showModal(`${successCount} student${successCount > 1 ? 's' : ''} added successfully!${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
            } else {
                showModal('Failed to add any students', 'error');
            }
        } catch (error) {
            console.error("Error adding students:", error);
            showModal('Error adding students: ' + error.message, 'error');
            
            // Reset button
            const submitBtn = document.querySelector('button[onclick="submitStudents()"]');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i><span>Save Students</span>';
            submitBtn.disabled = false;
        }
    }

    // Function to delete student
    async function deleteStudent() {
        const studentIdOrName = document.getElementById('deleteStudentId').value.trim();

        if (!studentIdOrName) {
            showModal('Please enter a Student ID or Name to delete.', 'warning');
            return;
        }

        try {
            // Show loading indicator
            const deleteBtn = document.querySelector('button[onclick="deleteStudent()"]');
            const originalContent = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Deleting...</span>';
            deleteBtn.disabled = true;
            
            const response = await fetch(`${API_BASE_URL}/${studentIdOrName}`, {
                method: 'DELETE',
            });

            // Reset button
            deleteBtn.innerHTML = originalContent;
            deleteBtn.disabled = false;
            
            if (!response.ok) {
                const result = await response.json();
                showModal(result.error || 'Failed to delete student.', 'error');
                return;
            }

            document.getElementById('deleteStudentModal').style.display = 'none';
            showModal('Student deleted successfully!', 'success');
            await fetchStudents();
        } catch (error) {
            // Reset button
            const deleteBtn = document.querySelector('button[onclick="deleteStudent()"]');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i><span>Delete Student</span>';
            deleteBtn.disabled = false;
            
            showModal('Error deleting student: ' + error.message, 'error');
        }
    }

    // Function to show modal messages
    function showModal(message, type = 'info') {
        const modal = document.getElementById('messageModal');
        const modalContent = modal.querySelector('.modal-content');
        const modalMessage = document.getElementById('modalMessage');
        const iconElement = modalContent.querySelector('i');
        
        // Remove existing types and add new one
        modalContent.classList.remove('success', 'error', 'info', 'warning');
        modalContent.classList.add(type);
        
        // Update icon based on type
        iconElement.className = ''; // Clear existing classes
        
        switch(type) {
            case 'success':
                iconElement.className = 'fas fa-check-circle text-green-500 text-4xl mb-4';
                break;
            case 'error':
                iconElement.className = 'fas fa-times-circle text-red-500 text-4xl mb-4';
                break;
            case 'info':
                iconElement.className = 'fas fa-info-circle text-blue-500 text-4xl mb-4';
                break;
            case 'warning':
                iconElement.className = 'fas fa-exclamation-triangle text-amber-500 text-4xl mb-4';
                break;
            default:
                iconElement.className = 'fas fa-info-circle text-blue-500 text-4xl mb-4';
        }
        
        modalMessage.textContent = message;
        modal.style.display = 'flex';
        
        setTimeout(() => {
            modal.style.display = 'none';
        }, 3000);
    }

    // Function to search students
    function searchStudents() {
        const searchText = document.getElementById('studentSearch').value.toLowerCase();
        const searchColumn = document.getElementById('searchColumn').value;
        currentPage = 1; // Reset to first page when searching

        // Filter students based on selected column
        let filteredStudents = storedStudentData;
        if (searchText) {
            filteredStudents = storedStudentData.filter(student => {
                switch(searchColumn) {
                    case 'id':
                        return student.id?.toString().toLowerCase().includes(searchText);
                    case 'name':
                        return student.name?.toLowerCase().includes(searchText);
                    case 'username':
                        return student.username?.toLowerCase().includes(searchText);
                    case 'cellphone':
                        return student.cellphone?.toLowerCase().includes(searchText);
                    case 'email':
                        return student.email?.toLowerCase().includes(searchText);
                    case 'all':
                    default:
                        return (
                            student.id?.toString().toLowerCase().includes(searchText) ||
                            student.name?.toLowerCase().includes(searchText) ||
                            student.username?.toLowerCase().includes(searchText) ||
                            student.cellphone?.toLowerCase().includes(searchText) ||
                            student.email?.toLowerCase().includes(searchText)
                        );
                }
            });
        }

        // Update the table with filtered results
        renderStudentsTable(filteredStudents);
    }

    // Function to logout
    function logout() {
        // Clear any stored user data
        localStorage.removeItem('userData');
        // Redirect to login page
        window.location.href = 'login.html';
    }

    // Event listeners
    document.getElementById('openDeleteModal-btn').onclick = function() {
        document.getElementById('deleteStudentId').value = '';
        document.getElementById('deleteStudentModal').style.display = 'flex';
    }

    document.getElementById('closeDeleteModal').onclick = function() {
        document.getElementById('deleteStudentModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const studentModal = document.getElementById('deleteStudentModal');
        const messageModal = document.getElementById('messageModal');
        const addStudentModal = document.getElementById('addStudentModal');
        
        if (event.target === studentModal) {
            studentModal.style.display = 'none';
        }
        if (event.target === messageModal) {
            messageModal.style.display = 'none';
        }
        if (event.target === addStudentModal) {
            closeModal();
        }
    }

    // Initialize the page
    window.onload = function() {
        fetchStudents();
    };

    // Function to export students to Excel
    async function exportToExcel() {
        if (!storedStudentData || storedStudentData.length === 0) {
            showModal('No student data to export.', 'error');
            return;
        }

        showModal('Preparing Excel file with QR codes...', 'info');

        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Students');

            worksheet.columns = [
                { header: 'Student ID', key: 'id', width: 15 },
                { header: 'Name', key: 'name', width: 25 },
                { header: 'Username', key: 'username', width: 20 },
                { header: 'Phone', key: 'cellphone', width: 20 },
                { header: 'Email', key: 'email', width: 30 },
                { header: 'QR Code', key: 'qr', width: 15 }
            ];

            worksheet.properties.defaultRowHeight = 80;

            for (const student of storedStudentData) {
                const row = worksheet.addRow({
                    id: student.id,
                    name: student.name,
                    username: student.username,
                    cellphone: student.cellphone,
                    email: student.email || 'N/A'
                });

                if (student.qr_code) {
                    try {
                        const imageId = workbook.addImage({
                            base64: student.qr_code,
                            extension: 'png',
                        });

                        worksheet.addImage(imageId, {
                            tl: { col: 5, row: row.number - 1 },
                            ext: { width: 100, height: 100 }
                        });
                    } catch (imgError) {
                        console.warn('Failed to add QR code for student:', student.id, imgError);
                    }
                }
            }

            // Style the header row
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0F2FE' }
            };

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student_records.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);

            showModal('Excel file generated successfully!', 'success');
        } catch (error) {
            console.error('Error generating Excel file:', error);
            showModal('Error generating Excel file: ' + error.message, 'error');
        }
    }

    // Add this new function for handling Excel import
    async function handleExcelImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            showModal('Reading Excel file...', 'info');
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(await file.arrayBuffer());
            
            const worksheet = workbook.getWorksheet(1);
            if (!worksheet) {
                showModal('No data found in the Excel file.', 'error');
                return;
            }

            const students = [];
            let rowNumber = 0;
            let errors = [];
            
            // Skip header row and process data
            worksheet.eachRow((row, rowNum) => {
                rowNumber = rowNum;
                if (rowNum === 1) return; // Skip header row
                
                const name = row.getCell(1).value;
                const username = row.getCell(2).value;
                let phone = row.getCell(3).value;
                const email = row.getCell(4).value;

                // Validate required fields
                if (!name || !username || !phone) {
                    errors.push(`Row ${rowNum}: Missing required fields (Name, Username, or Phone)`);
                    return;
                }

                // Convert phone to string and remove any '+' sign
                let phoneStr = phone.toString().replace(/^\+/, '');

                // Validate phone number format
                if (!phoneStr.startsWith('639') || phoneStr.length !== 12 || !/^639\d{9}$/.test(phoneStr)) {
                    errors.push(`Row ${rowNum}: Invalid phone number format. Must start with 639 and be followed by 9 digits (e.g., 639123456789)`);
                    return;
                }

                // Validate email format if provided
                if (email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        errors.push(`Row ${rowNum}: Invalid email format`);
                        return;
                    }
                }

                const student = {
                    name: name,
                    username: username,
                    password: 'password123', // Set default password for imported students
                    cellphone: '+' + phoneStr,
                    email: email || null
                };
                
                students.push(student);
            });

            if (errors.length > 0) {
                showModal(`Found ${errors.length} errors in the Excel file:\n${errors.join('\n')}`, 'error');
                return;
            }

            if (students.length === 0) {
                showModal('No valid student data found in the Excel file.', 'warning');
                return;
            }

            // Show confirmation modal with data summary
            const confirmMessage = `Found ${students.length} valid students to import:\n\n` +
                `Required fields present: Name, Username, Phone\n` +
                `Optional fields: Email\n\n` +
                `Would you like to proceed with the import?`;

            showImportConfirmModal(confirmMessage, async () => {
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    let errorMessages = [];

                    // Process students one at a time
                    for (const student of students) {
                        try {
                            const response = await fetch(API_BASE_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(student)
                            });

                            if (!response.ok) {
                                const result = await response.json();
                                throw new Error(result.error || 'Failed to add student');
                            }

                            successCount++;
                        } catch (error) {
                            errorCount++;
                            errorMessages.push(`Failed to import ${student.name} (${student.username}): ${error.message}`);
                        }
                    }

                    // Show results
                    if (successCount > 0) {
                        let message = `${successCount} student${successCount > 1 ? 's' : ''} imported successfully!`;
                        if (errorCount > 0) {
                            message += `\n\n${errorCount} student${errorCount > 1 ? 's' : ''} failed to import:`;
                            message += '\n' + errorMessages.join('\n');
                        }
                        showModal(message, errorCount > 0 ? 'warning' : 'success');
                        fetchStudents(); // Refresh the table
                    } else {
                        showModal('Failed to import any students:\n' + errorMessages.join('\n'), 'error');
                    }
                } catch (error) {
                    showModal('Error importing students: ' + error.message, 'error');
                }
            });
        } catch (error) {
            console.error('Error reading Excel file:', error);
            showModal('Error reading Excel file: ' + error.message, 'error');
        }
        
        // Reset file input
        event.target.value = '';
    }

    // Add this new function in the script section, before the window.onload function
    async function downloadImportTemplate() {
        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Students Template');

            // Define the columns
            worksheet.columns = [
                { header: 'Name*', key: 'name', width: 30 },
                { header: 'Username*', key: 'username', width: 20 },
                { header: 'Phone*', key: 'phone', width: 15 },
                { header: 'Email', key: 'email', width: 30 }
            ];

            // Style the header row
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0F2FE' }
            };

            // Add a sample row
            worksheet.addRow({
                name: 'John Doe',
                username: 'johndoe',
                phone: '639123456789',
                email: 'john.doe@example.com'
            });

            // Add instructions
            worksheet.addRow([]);
            worksheet.addRow(['Instructions:']);
            worksheet.addRow(['1. Required fields are marked with * (Name, Username, and Phone)']);
            worksheet.addRow(['2. Phone number must start with 639 followed by 9 digits (e.g., 639123456789)']);
            worksheet.addRow(['3. Email should be in a valid format (e.g., student@example.com)']);
            worksheet.addRow(['4. Password will be automatically set to "password123" for imported students']);
            worksheet.addRow(['5. IMPORTANT: DELETE THIS (INSTRUCTION) IF YOU ARE USING THIS TEMPLATE']);

            // Style the instructions
            for (let i = 2; i <= 7; i++) {
                worksheet.getRow(i).font = { italic: true };
                worksheet.getRow(i).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF8FAFC' }
                };
            }

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student_import_template.xlsx';
            a.click();
            window.URL.revokeObjectURL(url);

            showModal('Template downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating template:', error);
            showModal('Error generating template: ' + error.message, 'error');
        }
    }

    function showImportConfirmModal(message, onConfirm) {
        document.getElementById('importConfirmMessage').innerText = message;
        document.getElementById('importConfirmModal').style.display = 'flex';
        // Remove previous event listeners
        const confirmBtn = document.getElementById('confirmImportBtn');
        const newBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
        newBtn.onclick = async function() {
            await onConfirm();
            closeImportConfirmModal();
        };
    }

    function closeImportConfirmModal() {
        document.getElementById('importConfirmModal').style.display = 'none';
    }

    // Add this function after the renderStudentsTable function
    function togglePassword(button) {
        const passwordField = button.previousElementSibling;
        const icon = button.querySelector('i');
        
        if (passwordField.textContent === '••••••••') {
            passwordField.textContent = passwordField.dataset.password;
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.textContent = '••••••••';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Add these new functions after the existing script
    // Function to handle select all checkbox
    document.getElementById('selectAllStudents')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            if (this.checked) {
                selectedStudentIds.add(checkbox.dataset.studentId);
            } else {
                selectedStudentIds.delete(checkbox.dataset.studentId);
            }
        });
        isSelectAllChecked = this.checked;
        updateDeleteSelectedButton();
    });

    // Function to handle individual checkboxes
    function handleStudentCheckbox() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedStudentIds.add(this.dataset.studentId);
                } else {
                    selectedStudentIds.delete(this.dataset.studentId);
                }
                updateDeleteSelectedButton();
            });
        });
    }

    // Function to update delete selected button visibility
    function updateDeleteSelectedButton() {
        const deleteSelectedBtn = document.getElementById('deleteSelectedStudents-btn');
        if (selectedStudentIds.size > 0) {
            deleteSelectedBtn.classList.remove('hidden');
        } else {
            deleteSelectedBtn.classList.add('hidden');
        }
    }

    // Function to delete selected students
    async function deleteSelectedStudents() {
        const studentIds = Array.from(selectedStudentIds);

        if (studentIds.length === 0) {
            showModal('Please select at least one student to delete.', 'warning');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL.replace('/api/students', '/api')}/delete-students`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ studentIds: studentIds })
            });

            if (!response.ok) {
                const result = await response.json();
                showModal(result.error || 'Failed to delete students', 'error');
                return;
            }

            showModal(`${studentIds.length} student(s) deleted successfully!`, 'success');
            // Reset select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllStudents');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            // Hide delete selected button
            const deleteSelectedBtn = document.getElementById('deleteSelectedStudents-btn');
            if (deleteSelectedBtn) {
                deleteSelectedBtn.classList.add('hidden');
            }
            // Clear selected IDs
            selectedStudentIds.clear();
            // Refresh the students list
            await fetchStudents();
        } catch (error) {
            console.error('Error deleting students:', error);
            showModal('Error deleting students: ' + error.message, 'error');
        }
    }

    // Add event listener for delete selected button
    document.getElementById('deleteSelectedStudents-btn')?.addEventListener('click', deleteSelectedStudents);

    // Modify the fetchStudents function to add checkbox event listeners
    const originalFetchStudents = fetchStudents;
    fetchStudents = async function() {
        await originalFetchStudents();
        handleStudentCheckbox();
    };
    </script>
</body>
</html>
