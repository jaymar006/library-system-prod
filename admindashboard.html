<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="./node_modules/flowbite/dist/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        /* Custom scrollbar for sidebar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        /* Icon container styling */
        .icon-container {
            border: 2px solid #3b82f6;
            border-radius: 0.75rem;
            padding: 0.75rem;
            width: 4.75rem;
            height: 4.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0f2fe;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 8px rgba(59, 130, 246, 0.35);
        }
        .icon-container:hover, .icon-container:focus {
            background-color: #bae6fd;
            border-color: #2563eb;
            outline: none;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.7);
        }
        .icon-container i {
            color: #1e40af;
            font-size: 2.25rem;
            transition: color 0.3s ease;
        }
        .icon-label {
            font-size: 0.8rem;
            color: #475569;
            text-align: center;
            line-height: 1.2rem;
            user-select: none;
            min-height: 1.3rem;
            font-weight: 600;
        }
        .icon-value {
            font-weight: 700;
            font-size: 1rem;
            color: #1e293b;
            user-select: none;
            min-height: 1.3rem;
        }
        @media (max-width: 640px) {
            .icon-container {
                width: 3.75rem;
                height: 3.75rem;
                padding: 0.5rem;
                box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
            }
            .icon-container i {
                font-size: 1.75rem;
            }
            .icon-label {
                font-size: 0.7rem;
                min-height: 1rem;
            }
            .icon-value {
                font-size: 0.85rem;
                min-height: 1rem;
            }
            main {
                padding: 1rem;
            }
        }
        .line-path { stroke: #00008b; stroke-width: 3; fill: none; }
        .data-point { fill: #00008b; stroke: white; stroke-width: 2; }
        .data-point:hover, .data-point:focus { fill: #000066; r: 8; }
        .area-fill { fill: #e6e6ff; fill-opacity: 0.5; }
        .axis { stroke: #475569; stroke-width: 1; }
        .grid { stroke: #94a3b8; stroke-width: 0.5; stroke-dasharray: 4 4; }
        .label { font-family: Arial, sans-serif; font-size: 16px; fill: #1e293b; }
        .highlight { filter: drop-shadow(0 0 8px rgba(0,0,90,0.25)); }
        .line-path:hover, .line-path:focus {
            fill: #00008b !important;
            outline: none;
            filter: drop-shadow(0 0 6px rgba(0, 0, 139, 0.6));
        }

        /* Sidebar styles */
        .sidebar {
            transition: all 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 40;
            overflow-y: auto;
            height: 100vh;
            width: 256px;
            min-width: 256px;
            max-width: 256px;
        }

        .sidebar:hover {
            width: 256px !important;
            min-width: 256px !important;
            max-width: 256px !important;
        }

        .sidebar:not(:hover) {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
        }

        .sidebar:not(:hover) .nav-text,
        .sidebar:not(:hover) .welcome-text,
        .sidebar:not(:hover) .footer-text {
            display: none;
        }

        .sidebar:not(:hover) .nav-icon {
            margin-right: 0;
        }

        .sidebar:not(:hover) .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar:not(:hover) .profile-section {
            padding: 0.5rem;
        }

        .sidebar:not(:hover) .profile-image {
            width: 40px;
            height: 40px;
        }

        .sidebar:not(:hover) .footer-section {
            padding: 0.5rem;
        }

        /* Add styles for main content to account for fixed sidebar */
        main {
            margin-left: 80px;
            transition: margin-left 0.3s ease;
        }

        .sidebar:hover + main {
            margin-left: 256px;
        }

        /* Fix icon positioning */
        .nav-item {
            display: flex;
            align-items: center;
            position: relative;
        }

        .nav-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background-color: #10B981;
        }

        .toast.error {
            background-color: #EF4444;
        }

        .toast.info {
            background-color: #3B82F6;
        }

        .toast i {
            font-size: 20px;
        }
    </style>
</head>
<body class="bg-white font-sans text-base text-gray-700 relative">
    <!-- Toast Container -->
    <div id="toast" class="toast">
        <i class="fas"></i>
        <span id="toast-message"></span>
    </div>

    <div class="flex min-h-screen overflow-hidden">
        <div class="fixed top-0 right-0 z-50 flex gap-2 select-none p-2">
            <button onclick="window.electronAPI.minimize()" title="Minimize" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-blue-600 transition-colors duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 18L18 18"/></svg>
            </button>
            <button onclick="window.electronAPI.maximize()" title="Maximize/Restore" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-green-600 transition-colors duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="6" y="6" width="12" height="12" rx="2" stroke-width="2"/></svg>
            </button>
            <button onclick="window.electronAPI.close()" title="Close" class="w-8 h-8 flex items-center justify-center rounded hover:bg-red-100 active:bg-red-200 text-gray-600 hover:text-red-600 transition-colors duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 6l12 12M6 18L18 6"/></svg>
            </button>
        </div>
        <!-- Sidebar -->
        <aside class="sidebar bg-gray-100 w-64 min-w-[256px] max-w-[256px] flex flex-col py-6 px-3 select-none shrink-0 shadow-xl z-10 border-r border-gray-200 relative">
            <div class="flex flex-col items-center space-y-3 mb-8 profile-section">
                <div class="relative group">
                    <div class="absolute inset-0 bg-primary-100 rounded-full opacity-70 blur-md transform group-hover:scale-110 transition-all duration-300"></div>
                    <div class="relative bg-white rounded-full w-16 h-16 flex items-center justify-center shadow-md profile-image">
                        <img alt="Admin" class="rounded-full w-12 h-12 object-cover" src="assets/pic/removebgroyal.png"/>
                    </div>
                </div>
                <div class="text-center welcome-text">
                    <p class="text-xs font-bold uppercase tracking-wider mb-1 text-gray-500">Welcome</p>
                    <p class="text-lg font-bold text-gray-800">ADMIN</p>
                </div>
            </div>
            
            <nav class="w-full flex flex-col space-y-1 font-medium text-sm mt-2">
                <button id="dashboard-menu" 
                    onclick="Dashboard()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg bg-primary-100 text-primary-700 font-semibold transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-chart-line w-5 text-center nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </button>
                
                <button id="members-menu" 
                    onclick="window.location.href='adminstudentmodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-users w-5 text-center nav-icon"></i>
                    <span class="nav-text">Students</span>
                </button>
                
                <button id="books-menu" 
                    onclick="window.location.href='adminbookmodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-book w-5 text-center nav-icon"></i>
                    <span class="nav-text">Books</span>
                </button>
                
                <button id="history-menu" 
                    onclick="window.location.href='adminhistorymodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-history w-5 text-center nav-icon"></i>
                    <span class="nav-text">History</span>
                </button>
                
                <button id="borrowed-menu" 
                    onclick="Borrowed()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-hand-holding w-5 text-center nav-icon"></i>
                    <span class="nav-text">Borrow Book</span>
                </button>
                
                <button id="returned-menu" 
                    onclick="Returned()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-rotate-left w-5 text-center nav-icon"></i>
                    <span class="nav-text">Return Book</span>
                </button>
                
                <button onclick="window.location.href='rewards.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-trophy w-5 text-center nav-icon"></i>
                    <span class="nav-text">Rewards</span>
                </button>

                <button onclick="window.location.href='archive.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-archive w-5 text-center nav-icon"></i>
                    <span class="nav-text">Archive</span>
                </button>
                
                <div class="border-t border-gray-300 my-2 px-3"></div>
                
                <button onclick="logout()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-100 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-sign-out-alt w-5 text-center nav-icon"></i>
                    <span class="nav-text">Log Out</span>
                </button>
            </nav>
            
            <div class="mt-auto px-4 py-4 footer-section">
                <div class="bg-primary-50 border border-primary-100 rounded-lg px-3 py-2 text-xs text-gray-700 footer-text">
                    <p class="mb-1 font-medium text-gray-800">Royal Heirs Academy</p>
                    <p>Library Management System</p>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-secondary-50">
            <div class="container mx-auto px-4 py-6 max-w-7xl">
                <!-- Header Section -->
                <header class="mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-secondary-900 leading-tight">
                                Dashboard Overview
                            </h1>
                            <p class="mt-1 text-sm text-secondary-500" id="datetime">Loading date and time...</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0">
                            <button class="px-3 py-1.5 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all flex items-center text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>
                                <span onclick="fetchDashboardData()">Refresh Data</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Stats Cards Section -->
                <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4 mb-6">
                    <!-- Students Card -->
                    <div id="total-students" onclick="window.location.href='adminstudentmodule.html'" 
                        class="bg-white rounded-xl shadow-card p-6 hover:shadow-card-hover transition-all duration-300 cursor-pointer transform hover:-translate-y-1 border border-secondary-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-users text-xl"></i>
                    </div>
                            </div>
                            <div class="ml-5">
                                <p class="text-sm font-medium text-secondary-500 break-words whitespace-normal max-w-[7.5rem] sm:max-w-none leading-tight text-center">
                                    Total Students
                                </p>
                                <div class="flex items-baseline">
                                    <p class="text-2xl font-semibold text-secondary-900" id="students-count">
                                        <span class="animate-pulse-soft">•••</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Books Card -->
                    <div id="total-books" onclick="window.location.href='adminbookmodule.html'" 
                        class="bg-white rounded-xl shadow-card p-6 hover:shadow-card-hover transition-all duration-300 cursor-pointer transform hover:-translate-y-1 border border-secondary-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-book text-xl"></i>
                    </div>
                            </div>
                            <div class="ml-5">
                                <p class="text-sm font-medium text-secondary-500 break-words whitespace-normal max-w-[7.5rem] sm:max-w-none leading-tight text-center">
                                    Total Books
                                </p>
                                <div class="flex items-baseline">
                                    <p class="text-2xl font-semibold text-secondary-900" id="books-count">
                                        <span class="animate-pulse-soft">•••</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Borrowed Card -->
                    <div id="total-borrowed" onclick="window.location.href='adminhistorymodule.html'" 
                        class="bg-white rounded-xl shadow-card p-6 hover:shadow-card-hover transition-all duration-300 cursor-pointer transform hover:-translate-y-1 border border-secondary-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                                    <i class="fas fa-hand-holding text-xl"></i>
                    </div>
                            </div>
                            <div class="ml-5">
                                <p class="text-sm font-medium text-secondary-500 break-words whitespace-normal max-w-[7.5rem] sm:max-w-none leading-tight text-center">
                                    Borrowed Books
                                </p>
                                <div class="flex items-baseline">
                                    <p class="text-2xl font-semibold text-secondary-900" id="borrowed-count">
                                        <span class="animate-pulse-soft">•••</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Returned Card -->
                    <div id="total-returned" 
                        class="bg-white rounded-xl shadow-card p-6 hover:shadow-card-hover transition-all duration-300 cursor-pointer transform hover:-translate-y-1 border border-secondary-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full bg-amber-100 text-amber-600">
                                    <i class="fas fa-undo text-xl"></i>
                    </div>
                            </div>
                            <div class="ml-5">
                                <p class="text-sm font-medium text-secondary-500 break-words whitespace-normal max-w-[7.5rem] sm:max-w-none leading-tight text-center">
                                    Returned Books
                                </p>
                                <div class="flex items-baseline">
                                    <p class="text-2xl font-semibold text-secondary-900" id="returned-count">
                                        <span class="animate-pulse-soft">•••</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Card -->
                    <div id="total-pending" 
                        class="bg-white rounded-xl shadow-card p-6 hover:shadow-card-hover transition-all duration-300 cursor-pointer transform hover:-translate-y-1 border border-secondary-100">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full bg-red-100 text-red-600">
                                    <i class="fas fa-clock text-xl"></i>
                    </div>
                            </div>
                            <div class="ml-5">
                                <p class="text-sm font-medium text-secondary-500 break-words whitespace-normal max-w-[7.5rem] sm:max-w-none leading-tight text-center">
                                    Pending Returns
                                </p>
                                <div class="flex items-baseline">
                                    <p class="text-2xl font-semibold text-secondary-900" id="pending-count">
                                        <span class="animate-pulse-soft">•••</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Borrowing Chart Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-xl shadow-card overflow-hidden border border-secondary-100">
                        <div class="px-6 py-5 border-b border-secondary-100">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <h2 class="text-xl font-bold text-secondary-900">
                                    Borrowings by Month
                                </h2>
                                <div class="flex items-center space-x-3">
                                    <div class="text-xs font-medium px-2.5 py-1 rounded-full bg-primary-50 text-primary-600">
                                        Year: <span id="chart-year">2024</span>
                                    </div>
                                    <select id="timeframe-select" class="text-sm border-secondary-200 rounded-lg focus:border-primary-500 focus:ring focus:ring-primary-200 focus:ring-opacity-50 bg-white shadow-sm">
                                        <option value="last6months">Last 6 Months</option>
                                        <option value="thisyear">This Year</option>
                                        <option value="alltime">All Time</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="relative h-80">
                                <svg class="w-full h-full" viewBox="0 0 700 320" xmlns="http://www.w3.org/2000/svg" id="bar-chart" tabindex="0" aria-describedby="tooltip" aria-label="Line chart showing books borrowed each month from January to June">
                                    <!-- Gradient for area fill -->
                                    <defs>
                                        <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" stop-color="#0ea5e9" stop-opacity="0.5"/>
                                            <stop offset="100%" stop-color="#0ea5e9" stop-opacity="0.1"/>
                                        </linearGradient>
                                    </defs>
                                    
                        <!-- Grid lines -->
                        <line class="grid" x1="50" x2="650" y1="270" y2="270"></line>
                        <line class="grid" x1="50" x2="650" y1="218" y2="218"></line>
                        <line class="grid" x1="50" x2="650" y1="166" y2="166"></line>
                        <line class="grid" x1="50" x2="650" y1="114" y2="114"></line>
                        <line class="grid" x1="50" x2="650" y1="62" y2="62"></line>
                        <line class="grid" x1="50" x2="650" y1="10" y2="10"></line>
                                    
                        <!-- Y axis labels -->
                        <text class="label" x="20" y="270">0</text>
                        <text class="label" x="20" y="218">20</text>
                        <text class="label" x="20" y="166">40</text>
                        <text class="label" x="20" y="114">60</text>
                        <text class="label" x="20" y="62">80</text>
                        <text class="label" x="20" y="15">100</text>
                                    
                        <!-- X axis labels -->
                        <text class="label x-label" x="100" y="290">Jan</text>
                        <text class="label x-label" x="200" y="290">Feb</text>
                        <text class="label x-label" x="300" y="290">Mar</text>
                        <text class="label x-label" x="400" y="290">Apr</text>
                        <text class="label x-label" x="500" y="290">May</text>
                        <text class="label x-label" x="600" y="290">Jun</text>
                    </svg>
                                <div aria-live="polite" class="absolute top-3 right-3 bg-white shadow-lg rounded-lg border border-secondary-200 p-3 text-sm text-secondary-800 max-w-xs hidden" id="tooltip" role="tooltip">
                                    <div class="font-medium"></div>
                                </div>
                            </div>
                            
                            
                </div>
            </section>

            <!-- Overdue Books Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-xl shadow-card overflow-hidden border border-secondary-100">
                        <div class="px-6 py-5 border-b border-secondary-100 bg-gradient-to-r from-red-50 to-pink-50">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 flex items-center justify-center rounded-full bg-red-100 text-red-600 mr-4">
                                        <i class="fas fa-exclamation-circle text-xl"></i>
                                    </div>
                                    <h2 class="text-xl font-bold text-secondary-900">
                                        Overdue Books
                                    </h2>
                                </div>
                                
                            </div>
                        </div>
                        
                        <div id="overdueBooks" class="p-6 overflow-hidden">
                            <!-- Content will be dynamically populated -->
                            <div class="flex items-center justify-center h-40">
                                <div class="text-center">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-4"></div>
                                    <p class="text-secondary-500">Loading overdue books...</p>
                                </div>
                            </div>
                        </div>
                </div>
            </section>
                
                <!-- Hidden Print Container -->
                <div id="printContainer" style="display: none;">
                    <div id="qrList" class="grid grid-cols-2 gap-4"></div>
                </div>
                
                <!-- Message Modal -->
                <div id="messageModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
                    <div class="modal-content bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4 success">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                            <p class="modal-message text-lg font-semibold"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Logout Confirmation Modal -->
    <div id="logoutModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-sign-out-alt text-red-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold mb-2">Confirm Logout</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to log out?</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeLogoutModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        let storedStudentData = [];
        let currentSort = {
            column: null,
            direction: 'asc'
        };

        // Add pagination state variables
        let currentPage = 1;
        let booksPerPage = 5;
        let allOverdueBooks = [];

        window.onload = function() {
            // Initially hide the dashboard
            document.getElementById('dashboardContent') && (document.getElementById('dashboardContent').style.display = 'none');
            document.getElementById('fetch-history') && (document.getElementById('fetch-history').style.display = 'none');
            document.getElementById('dashboardAdmin') && (document.getElementById('dashboardAdmin').style.display = 'block');
            document.getElementById('booksContent') && (document.getElementById('booksContent').style.display = 'none');
            
            if (typeof addEditBookModal === 'function') {
            addEditBookModal();
            }
        };

        // Update datetime
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-US', options);
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);

        // Navigation Functions
        async function showBooks() {
            document.getElementById('dashboardContent') && (document.getElementById('dashboardContent').style.display = 'none');
            document.getElementById('booksContent') && (document.getElementById('booksContent').style.display = 'block');
            document.getElementById('fetch-history') && (document.getElementById('fetch-history').style.display = 'none');
            document.getElementById('dashboardAdmin') && (document.getElementById('dashboardAdmin').style.display = 'none');
            
            currentSort = {
                column: null,
                direction: 'asc'    
            };
            
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            await fetchBooks();
            
            const booksTable = document.querySelector('.books-table');
            if (booksTable) {
                booksTable.style.display = 'table';
            }
            
            setTimeout(() => {
                const tbody = document.querySelector('.books-table tbody');
                if (tbody) {
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    rows.sort((a, b) => {
                        const aId = parseInt(a.querySelector('td:first-child').textContent);
                        const bId = parseInt(b.querySelector('td:first-child').textContent);
                        return aId - bId;
                    });
                    rows.forEach(row => tbody.appendChild(row));
                }
            }, 100);
        }

        function Members() {
            document.getElementById('booksContent') && (document.getElementById('booksContent').style.display = 'none');
            document.getElementById('dashboardContent') && (document.getElementById('dashboardContent').style.display = 'block');
            document.getElementById('fetch-history') && (document.getElementById('fetch-history').style.display = 'none');
            document.getElementById('dashboardAdmin') && (document.getElementById('dashboardAdmin').style.display = 'none');
            fetchStudents();
        }

        function showHistory() {
            document.getElementById('dashboardContent') && (document.getElementById('dashboardContent').style.display = 'none');
            document.getElementById('booksContent') && (document.getElementById('booksContent').style.display = 'none');
            document.getElementById('fetch-history') && (document.getElementById('fetch-history').style.display = 'block');
            document.getElementById('dashboardAdmin') && (document.getElementById('dashboardAdmin').style.display = 'none');
            fetchHistory();
        }

        function Dashboard() {
            document.getElementById('booksContent') && (document.getElementById('booksContent').style.display = 'none');
            document.getElementById('dashboardAdmin') && (document.getElementById('dashboardAdmin').style.display = 'block');
            document.getElementById('fetch-history') && (document.getElementById('fetch-history').style.display = 'none');
            document.getElementById('dashboardContent') && (document.getElementById('dashboardContent').style.display = 'none');
            fetchDashboardData();
        }

        function Borrowed() {
            window.location.href = 'borrowed.html';
        }

        function Returned() {
            window.location.href = 'returned.html';
        }

        function logout() {
            showLogoutModal();
        }

        // Data Fetching Functions
        async function fetchBooks() {
            try {
                const result = await window.electronAPI.getBooks();
                if (result.success) {
                    const tableBody = document.querySelector(".books-table tbody");
                    tableBody.innerHTML = "";

                    result.books.forEach((book) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${book.id}</td>
                            <td>${book.ISBN}</td>
                            <td>${book.name}</td>
                            <td>${book.author}</td>
                            <td>${book.publication_year || "N/A"}</td>
                            <td>${book.category || "N/A"}</td>
                            <td>${book.language || "N/A"}</td>
                            <td>${book.shelf_location || "N/A"}</td>
                            <td>${book.copies_available || 0}</td>
                            <td>${book.number_of_page || "N/A"}</td>
                            <td>${book.tags || "N/A"}</td>
                            <td>
                                ${book.image_url ? `<img src="${book.image_url}" alt="Book Cover" width="100">` : "No Image"}
                            </td>
                            <td>
                                ${book.qr_code ? `<img src="${book.qr_code}" alt="QR Code" width="100">` : "No QR"}
                            </td>
                            <td>
                                <button onclick="editBook(${book.id}, '${book.shelf_location || ''}', ${book.copies_available || 0})" class="edit-btn">Edit</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    document.querySelectorAll('.sortable').forEach(header => {
                        header.addEventListener('click', () => {
                            const column = header.dataset.sort;
                            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                            currentSort = { column, direction };
                            sortTable(column, direction);
                        });
                    });
                } else {
                    console.error("Error fetching books:", result.error);
                }
            } catch (error) {
                console.error("Error fetching books:", error);
            }
        }

        async function fetchDashboardData() {
            try {
                // Show loading indicators
                document.getElementById('students-count').innerHTML = '<span class="animate-pulse-soft">•••</span>';
                document.getElementById('books-count').innerHTML = '<span class="animate-pulse-soft">•••</span>';
                document.getElementById('borrowed-count').innerHTML = '<span class="animate-pulse-soft">•••</span>';
                document.getElementById('returned-count').innerHTML = '<span class="animate-pulse-soft">•••</span>';
                document.getElementById('pending-count').innerHTML = '<span class="animate-pulse-soft">•••</span>';

                console.log('Fetching dashboard data...');
                const response = await fetch('http://localhost:5000/api/dashboard');
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data received:', data);
                
                // Safely extract values with fallbacks
                const studentCount = data.totalStudents || data.students || 0;
                const bookCount = data.totalBooks || data.books || 0;
                const borrowedCount = data.totalBorrowedBooks || data.borrowed || data.borrowedBooks || 0;
                const returnedCount = data.returnedBooks || data.returned || 0;
                const pendingCount = data.pendingBooks || data.pending || 0;
                
                // Apply number animations using a simple incremental counter
                animateNumber('students-count', studentCount);
                animateNumber('books-count', bookCount);
                animateNumber('borrowed-count', borrowedCount);
                animateNumber('returned-count', returnedCount);
                animateNumber('pending-count', pendingCount);
                
                // Refresh other dashboard components
                checkOverdueBooks();
                initializeChart(); // Ensure chart is initialized
                fetchChartData();
                
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                
                // Set error state with clear indication there's a problem
                document.getElementById('students-count').innerHTML = '<span class="text-red-500">0</span>';
                document.getElementById('books-count').innerHTML = '<span class="text-red-500">0</span>';
                document.getElementById('borrowed-count').innerHTML = '<span class="text-red-500">0</span>';
                document.getElementById('returned-count').innerHTML = '<span class="text-red-500">0</span>';
                document.getElementById('pending-count').innerHTML = '<span class="text-red-500">0</span>';
                
                showModal('Failed to load dashboard data: ' + error.message, 'error');
                
                // Attempt to load fallback data directly from other sources
                fetchFallbackData();
            }
        }
        
        // Fallback data function
        async function fetchFallbackData() {
            try {
                console.log('Attempting to fetch fallback data...');
                
                // Try to get students directly
                try {
                    const studentsResponse = await fetch('http://localhost:5000/api/students');
                    if (studentsResponse.ok) {
                        const studentsData = await studentsResponse.json();
                        if (Array.isArray(studentsData)) {
                            animateNumber('students-count', studentsData.length);
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch students count:', e);
                }
                
                // Try to get books directly
                try {
                    const booksResponse = await fetch('http://localhost:5000/api/books');
                    if (booksResponse.ok) {
                        const booksData = await booksResponse.json();
                        if (Array.isArray(booksData)) {
                            animateNumber('books-count', booksData.length);
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch books count:', e);
                }
                
                // Try to init chart with dummy data if needed
                initializeChart(); 
                
            } catch (error) {
                console.error('Fallback data fetch also failed:', error);
            }
        }
        
        // Initialize chart with fallback data if needed
        function initializeChart() {
            // Use empty data (all zeros) instead of placeholder data
            const chartData = {
                books: [0, 0, 0, 0, 0, 0]
            };
            
            // Update chart with data
            updateChart(chartData);
            
            // Set up tooltip interactions
            setupChartInteractions();
        }
        
        // Redefine setupChartInteractions function that was removed
        function setupChartInteractions() {
            const tooltip = document.getElementById('tooltip');
            const svg = document.getElementById('bar-chart');
            
            if (!tooltip || !svg) return;
            
            // Show tooltip
            function showTooltip(content, x, y) {
                tooltip.innerHTML = `<div class="font-medium">${content}</div>`;
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
                tooltip.classList.remove('hidden');
            }
            
            // Hide tooltip
            function hideTooltip() {
                tooltip.classList.add('hidden');
            }
            
            // Add event listeners to data points
            svg.querySelectorAll('.data-point').forEach(point => {
                point.addEventListener('mouseenter', e => {
                    const month = point.getAttribute('data-month');
                    const value = point.getAttribute('data-value');
                    const rect = point.getBoundingClientRect();
                    showTooltip(`${month}: ${value} books`, rect.right + window.scrollX - 100, rect.top + window.scrollY - 40);
                    point.classList.add('highlight');
                });
                
                point.addEventListener('mouseleave', () => {
                    hideTooltip();
                    point.classList.remove('highlight');
                });
            });
        }
        
        // Define this function again
        function getMonthName(index) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June'];
            return months[index];
        }
        
        // Add fetch chart data function back
        async function fetchChartData(timeframe = 'last6months') {
            try {
                // Get the current year
                const currentYear = new Date().getFullYear();
                document.getElementById('chart-year').textContent = currentYear;
                
                console.log('Fetching chart data with timeframe:', timeframe);
                // Fetch history data from the API
                const response = await fetch('http://localhost:5000/api/history');
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const historyData = await response.json();
                console.log('Chart data received:', historyData);
                
                // If no data available, use empty data instead of placeholder
                if (!historyData || (Array.isArray(historyData) && historyData.length === 0)) {
                    console.log('No history data found, showing empty chart');
                    updateChart({
                        books: [0, 0, 0, 0, 0, 0]
                    });
                    return;
                }
                
                // Handle both array and object response formats
                const records = Array.isArray(historyData) ? historyData : 
                               (historyData.data || historyData.history || historyData.records || []);
                
                if (!Array.isArray(records)) {
                    console.warn('Unexpected history data format:', historyData);
                    updateChart({
                        books: [0, 0, 0, 0, 0, 0]
                    });
                    return;
                }

                let bookCounts;
                let summaryLabels = [];
                
                // Update the chart title if needed based on timeframe
                const chartTitle = document.querySelector('.text-xl.font-bold.text-secondary-900');
                if (chartTitle) {
                    if (timeframe === 'alltime') {
                        chartTitle.textContent = 'Borrowings by Year';
                    } else {
                        chartTitle.textContent = 'Borrowings by Month';
                    }
                }
                
                if (timeframe === 'last6months') {
                    // Initialize arrays for each month (0-5 for last 6 months)
                    bookCounts = [0, 0, 0, 0, 0, 0];
                    
                    // Create month labels for last 6 months
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                        'July', 'August', 'September', 'October', 'November', 'December'];
                    const today = new Date();
                    
                    for (let i = 5; i >= 0; i--) {
                        let monthIndex = today.getMonth() - i;
                        let yearOffset = 0;
                        
                        if (monthIndex < 0) {
                            monthIndex += 12;
                            yearOffset = -1;
                        }
                        
                        summaryLabels.unshift(monthNames[monthIndex].slice(0, 3));
                        
                        // Update month labels in the chart
                        const xLabels = document.querySelectorAll('text.x-label');
                        if (xLabels && xLabels.length > 6) {
                            xLabels[i + 1].textContent = monthNames[monthIndex].slice(0, 3);
                        }
                    }
                    
                    // Count all borrowings by month from the history data
                    records.forEach(record => {
                        try {
                            // Extract date from borrow_date (handle different property names)
                            const dateStr = record.borrow_date || record.borrowDate || record.date;
                            if (!dateStr) return;
                            
                            const borrowDate = new Date(dateStr);
                            if (isNaN(borrowDate.getTime())) return; // Skip invalid dates
                            
                            const today = new Date();
                            
                            // Check if the borrowing happened in the last 6 months
                            const sixMonthsAgo = new Date();
                            sixMonthsAgo.setMonth(today.getMonth() - 5); // Starting from 6 months ago (including current month)
                            sixMonthsAgo.setDate(1); // Start of the month
                            
                            if (borrowDate >= sixMonthsAgo) {
                                // Calculate which of the last 6 months this belongs to
                                const monthDiff = (today.getMonth() - borrowDate.getMonth() + 12) % 12;
                                
                                if (monthDiff <= 5) {
                                    const index = 5 - monthDiff; // Reverse the index (5 = current month, 0 = 6 months ago)
                                    bookCounts[index] += 1;
                                    
                                    // Cap at 25 to prevent overflow
                                    if (bookCounts[index] > 25) {
                                        bookCounts[index] = 25;
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Error processing history record:', e);
                        }
                    });
                } else if (timeframe === 'thisyear') {
                    // Initialize arrays for each month (0-11 for Jan-Dec)
                    bookCounts = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    
                    // Set standard month labels
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    summaryLabels = monthNames.slice(0, 6);
                    
                    // Update month labels for all months
                    const xLabels = document.querySelectorAll('text.x-label');
                    if (xLabels && xLabels.length > 6) {
                        for (let i = 0; i < 6; i++) {
                            // Skip the first label (axis) and use only first 6 months for display
                            xLabels[i + 1].textContent = monthNames[i];
                        }
                    }
                    
                    // Count all borrowings by month from the history data for this year
                    records.forEach(record => {
                        try {
                            const dateStr = record.borrow_date || record.borrowDate || record.date;
                            if (!dateStr) return;
                            
                            const borrowDate = new Date(dateStr);
                            if (isNaN(borrowDate.getTime())) return; // Skip invalid dates
                            
                            // Only count records from current year
                            if (borrowDate.getFullYear() === currentYear) {
                                const month = borrowDate.getMonth(); // 0-based (0 = Jan)
                                bookCounts[month] += 1;
                                
                                // Cap at 25 to prevent overflow
                                if (bookCounts[month] > 25) {
                                    bookCounts[month] = 25;
                                }
                            }
                        } catch (e) {
                            console.warn('Error processing history record:', e);
                        }
                    });
                    
                    // Use only first 6 months for display
                    bookCounts = bookCounts.slice(0, 6);
                } else if (timeframe === 'alltime') {
                    // For all time, group by years instead of months (last 6 years)
                    const yearCounts = {};
                    const currentYear = new Date().getFullYear();
                    
                    // Initialize counts for last 6 years
                    const years = [];
                    for (let i = 0; i < 6; i++) {
                        const year = currentYear - 5 + i;
                        years.push(year);
                        yearCounts[year] = 0;
                    }
                    
                    // Set year labels instead of month labels
                    summaryLabels = years.map(y => y.toString());
                    
                    // Update labels to show years instead of months
                    const xLabels = document.querySelectorAll('text.x-label');
                    if (xLabels && xLabels.length > 6) {
                        for (let i = 0; i < 6; i++) {
                            // Skip the first label (axis)
                            xLabels[i + 1].textContent = years[i].toString();
                        }
                    }
                    
                    // Count all borrowings by year
                    records.forEach(record => {
                        try {
                            const dateStr = record.borrow_date || record.borrowDate || record.date;
                            if (!dateStr) return;
                            
                            const borrowDate = new Date(dateStr);
                            if (isNaN(borrowDate.getTime())) return;
                            
                            const year = borrowDate.getFullYear();
                            
                            // Check if this year is in our range of last 6 years
                            if (year >= currentYear - 5 && year <= currentYear) {
                                yearCounts[year] = (yearCounts[year] || 0) + 1;
                                
                                // Cap at 25 to prevent overflow
                                if (yearCounts[year] > 25) {
                                    yearCounts[year] = 25;
                                }
                            }
                        } catch (e) {
                            console.warn('Error processing history record:', e);
                        }
                    });
                    
                    // Convert to array for chart
                    bookCounts = years.map(year => yearCounts[year]);
                }
                
                // Update the chart with real data
                updateChart({
                    books: bookCounts
                });
                
                // Update summary cards at the bottom
                for (let i = 0; i < 6; i++) {
                    const labelElement = document.getElementById(`summary-label-${i}`);
                    const valueElement = document.getElementById(`summary-value-${i}`);
                    
                    if (labelElement && summaryLabels[i]) {
                        labelElement.textContent = summaryLabels[i];
                    }
                    
                    if (valueElement && bookCounts[i] !== undefined) {
                        valueElement.textContent = bookCounts[i];
                    }
                }
                
            } catch (error) {
                console.error('Error fetching chart data:', error);
                // Use empty data in case of error instead of placeholder
                updateChart({
                    books: [0, 0, 0, 0, 0, 0]
                });
            }
        }

        // Animation helper function
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Don't animate for small numbers
            if (targetNumber < 20) {
                element.textContent = targetNumber;
                return;
            }
            
            let currentNumber = 0;
            const duration = 1000; // ms
            const interval = 20; // ms
            const steps = duration / interval;
            const increment = targetNumber / steps;
            
            const counter = setInterval(() => {
                currentNumber += increment;
                if (currentNumber >= targetNumber) {
                    clearInterval(counter);
                    currentNumber = targetNumber;
                }
                element.textContent = Math.floor(currentNumber);
            }, interval);
        }

        // Modal Functions
        function showModal(message, type) {
            const modal = document.getElementById('messageModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalMessage = modal.querySelector('.modal-message');
            
            modalMessage.textContent = message;
            
            // Remove existing types and add new one
            modalContent.classList.remove('success', 'error', 'info', 'warning');
            modalContent.classList.add(type);
            
            // Update icon based on type
            const iconElement = modalContent.querySelector('i');
            iconElement.className = ''; // Clear existing classes
            
            switch(type) {
                case 'success':
                    iconElement.className = 'fas fa-check-circle text-green-500 text-4xl mb-4';
                    break;
                case 'error':
                    iconElement.className = 'fas fa-times-circle text-red-500 text-4xl mb-4';
                    break;
                case 'info':
                    iconElement.className = 'fas fa-info-circle text-blue-500 text-4xl mb-4';
                    break;
                case 'warning':
                    iconElement.className = 'fas fa-exclamation-triangle text-amber-500 text-4xl mb-4';
                    break;
                default:
                    iconElement.className = 'fas fa-check-circle text-green-500 text-4xl mb-4';
            }
            
            // Show modal with fade-in effect
            modal.classList.add('opacity-0');
            modal.style.display = 'flex';
            
            // Trigger animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
            }, 10);
            
            // Auto-close after delay
            setTimeout(() => {
                modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.style.display = 'none';
                    modal.classList.remove('opacity-0');
                }, 300);
            }, 3000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchDashboardData();
            checkOverdueBooks();
            initializeChart();
            
            // Initial fetch with default timeframe
            fetchChartData('last6months');
            
            // Add event listener for timeframe select
            const timeframeSelect = document.getElementById('timeframe-select');
            if (timeframeSelect) {
                timeframeSelect.addEventListener('change', (event) => {
                    const timeframe = event.target.value;
                    fetchChartData(timeframe);
                });
            }
            
            // Set up auto-refresh
            setInterval(checkOverdueBooks, 300000); // Check overdue books every 5 minutes

            // Check if this is a fresh login
            const isFreshLogin = sessionStorage.getItem('freshLogin');
            if (isFreshLogin) {
                showToast('Welcome back! You have successfully logged in.', 'success');
                sessionStorage.removeItem('freshLogin');
            }
        });

        // Update chart functions to match the new UI design
        function updateChart(data) {
            const svgElement = document.getElementById('bar-chart');
            if (!svgElement) return;
            
            // Clear existing elements
            const existingElements = svgElement.querySelectorAll('.line-path, .data-point, .area-fill');
            existingElements.forEach(el => el.remove());
            
            // Calculate maximum value for scaling - use max scale of 25
            const maxValue = 100; // Fixed scale to 100
            const scale = 260 / maxValue; // 270-10 = 260px for 0-100
            
            const monthPositions = [100, 200, 300, 400, 500, 600]; // X positions for each month
            
            // Create points for the line
            const points = [];
            let pathData = '';
            let areaPathData = '';
            
            // Update the month summary displays
            const monthDisplays = document.querySelectorAll('main .mt-4.grid .text-lg');
            
            data.books.forEach((value, index) => {
                // Cap value at maximum
                const actualValue = Math.min(value, maxValue);
                const y = 270 - (actualValue * scale); // Adjust for baseline
                const x = monthPositions[index];
                
                points.push({x, y, value});
                
                // Start or continue the path
                if (index === 0) {
                    pathData = `M ${x} ${y}`;
                    areaPathData = `M ${x} 270 L ${x} ${y}`; // Adjust for baseline
                } else {
                    pathData += ` L ${x} ${y}`;
                    areaPathData += ` L ${x} ${y}`;
                }
                
                // Update month summary if available
                if (monthDisplays && monthDisplays[index]) {
                    monthDisplays[index].textContent = value;
                }
            });
            
            // Close the area path back to the baseline
            if (points.length > 0) {
                areaPathData += ` L ${monthPositions[points.length-1]} 270 Z`; // Adjust for baseline
            }
            
            // Create the area fill below the line
            const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            areaPath.setAttribute('class', 'area-fill');
            areaPath.setAttribute('d', areaPathData);
            svgElement.appendChild(areaPath);
            
            // Create the line path
            const linePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            linePath.setAttribute('class', 'line-path');
            linePath.setAttribute('d', pathData);
            svgElement.appendChild(linePath);
            
            // Add data points
            points.forEach(point => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'data-point');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 6);
                circle.setAttribute('tabindex', '0');
                circle.setAttribute('role', 'button');
                circle.setAttribute('data-month', getMonthName(points.indexOf(point)));
                circle.setAttribute('data-value', point.value);
                circle.setAttribute('aria-label', `Books borrowed in ${getMonthName(points.indexOf(point))}: ${point.value}`);
                
                svgElement.appendChild(circle);
            });
            
            // Set up interactive tooltip
            setupChartInteractions();
        }

        // Add function to check overdue books
        async function checkOverdueBooks() {
            try {
                // Show loading state
                const overdueSection = document.getElementById('overdueBooks');
                if (!overdueSection) return;
                
                overdueSection.innerHTML = `
                    <div class="flex items-center justify-center h-40">
                        <div class="text-center">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-4"></div>
                            <p class="text-secondary-500">Loading overdue books...</p>
                        </div>
                    </div>`;
                
                console.log('Fetching overdue books...');
                const response = await fetch('http://localhost:5000/api/overdue-books');
                const result = await response.json();
                
                console.log('API response:', result);

                // Handle both response formats
                allOverdueBooks = Array.isArray(result) ? result : (result.overdueBooks || result.books || result);
                
                if (!allOverdueBooks || !Array.isArray(allOverdueBooks) || allOverdueBooks.length === 0) {
                    console.log('No overdue books found in the response');
                    overdueSection.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 text-secondary-400">
                            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                            <p class="text-lg font-medium">No overdue books at the moment</p>
                            <p class="text-sm mt-2">All books have been returned on time</p>
                        </div>`;
                    return;
                }

                console.log(`Found ${allOverdueBooks.length} overdue books`);
                
                // Reset to first page when refreshing data
                currentPage = 1;
                
                // Render the books with pagination
                renderOverdueBooks();
            } catch (error) {
                console.error('Error fetching overdue books:', error);
                const overdueSection = document.getElementById('overdueBooks');
                if (overdueSection) {
                    overdueSection.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 text-red-500">
                            <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                            <p class="text-lg font-medium">Unable to load overdue books</p>
                            <p class="text-sm mt-2">Please check your connection and try again</p>
                            <button onclick="checkOverdueBooks()" class="mt-4 px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                                Try Again
                            </button>
                        </div>`;
                }
            }
        }

        function renderOverdueBooks() {
            const overdueSection = document.getElementById('overdueBooks');
            if (!overdueSection) return;
            
            // Store the current search input value and cursor position
            const searchInput = document.getElementById('search-overdue');
            const searchText = searchInput ? searchInput.value : '';
            const cursorPosition = searchInput ? searchInput.selectionStart : 0;
            
            // Calculate pagination values
            const totalBooks = allOverdueBooks.length;
            const totalPages = Math.ceil(totalBooks / booksPerPage);
            const startIndex = (currentPage - 1) * booksPerPage;
            const endIndex = Math.min(startIndex + booksPerPage, totalBooks);
            const currentBooks = allOverdueBooks.slice(startIndex, endIndex);
            
            // Create a temporary container to hold the new content
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 text-sm text-secondary-600">
                    <div class="flex items-center space-x-3 mb-3 sm:mb-0">
                        <span class="text-xs font-medium bg-primary-50 text-primary-700 px-2.5 py-1 rounded-full">
                            ${startIndex + 1}-${endIndex} of ${totalBooks}
                        </span>
                        <button id="prev-page" class="text-secondary-600 font-medium flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="next-page" class="text-secondary-600 font-medium flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary-400"></i>
                        <input id="search-overdue" value="${searchText}" class="rounded-full pl-10 pr-4 py-2 text-sm font-medium text-secondary-600 placeholder-secondary-400 bg-secondary-50 border border-secondary-200 w-64 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" type="search" placeholder="Search books or students..."/>
                    </div>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-secondary-200">
                    <table class="w-full text-sm text-left">
                        <thead>
                            <tr class="bg-secondary-50 text-secondary-600 font-semibold border-b border-secondary-200">
                                <th class="py-3 px-4 whitespace-nowrap">Book Title</th>
                                <th class="py-3 px-4 whitespace-nowrap">Student Name</th>
                                <th class="py-3 px-4 whitespace-nowrap">Borrow Date</th>
                                <th class="py-3 px-4 whitespace-nowrap">Due Date</th>
                                <th class="py-3 px-4 whitespace-nowrap">Days Overdue</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-secondary-100">
                            ${currentBooks.map(book => {
                                const title = book.title || book.book_name || book.name || 'Unknown';
                                const studentName = book.studentName || book.student_name || 'Unknown';
                                const borrowDate = book.borrowDate || book.borrow_date || new Date().toISOString();
                                const dueDate = book.dueDate || book.due_date || new Date().toISOString();
                                
                                const dueDateObj = new Date(dueDate);
                                const borrowDateObj = new Date(borrowDate);
                                const now = new Date();
                                const daysOverdue = Math.max(0, Math.floor((now - dueDateObj) / (1000 * 60 * 60 * 24)));
                                
                                let severityClass = 'bg-yellow-50 text-yellow-800';
                                if (daysOverdue > 7) {
                                    severityClass = 'bg-red-50 text-red-800';
                                } else if (daysOverdue > 3) {
                                    severityClass = 'bg-orange-50 text-orange-800';
                                }
                                
                                return `
                                    <tr class="hover:bg-secondary-50 transition-colors">
                                        <td class="py-3 px-4 font-medium text-secondary-900">
                                            ${title}
                                        </td>
                                        <td class="py-3 px-4">${studentName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap">${formatDateOnly(borrowDateObj)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap">${formatDateOnly(dueDateObj)}</td>
                                        <td class="py-3 px-4">
                                            <span class="inline-flex items-center justify-center px-2.5 py-1 rounded-full text-xs font-medium ${severityClass}">
                                                ${daysOverdue} days
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Update the content
            overdueSection.innerHTML = tempContainer.innerHTML;
            
            // Add event listeners for pagination buttons
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderOverdueBooks();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderOverdueBooks();
                }
            });
            
            // Add search functionality and restore focus
            const newSearchInput = document.getElementById('search-overdue');
            if (newSearchInput) {
                newSearchInput.removeEventListener('input', handleSearch);
                newSearchInput.addEventListener('input', handleSearch);
                newSearchInput.value = searchText;
                // Don't call focus() here to prevent focus issues
            }
        }

        function handleSearch(e) {
            const searchText = e.target.value.toLowerCase();
            const searchInput = e.target;
            
            if (searchText.trim() === '') {
                checkOverdueBooks();
                return;
            }
            
            const filteredBooks = allOverdueBooks.filter(book => {
                const title = (book.title || book.book_name || book.name || '').toLowerCase();
                const studentName = (book.studentName || book.student_name || '').toLowerCase();
                return title.includes(searchText) || studentName.includes(searchText);
            });
            
            if (filteredBooks.length === 0) {
                const overdueSection = document.getElementById('overdueBooks');
                const searchContainer = overdueSection.querySelector('.relative');
                const existingSearchInput = searchContainer.querySelector('input');
                
                // Update the content while preserving the search input
                overdueSection.innerHTML = `
                    <div class="flex justify-between items-center mb-4 text-sm text-secondary-600">
                        <div class="flex items-center space-x-3">
                            <span class="text-xs font-medium bg-primary-50 text-primary-700 px-2.5 py-1 rounded-full">0 results</span>
                            <button class="text-secondary-600 font-medium flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all opacity-50 cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="text-secondary-600 font-medium flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all opacity-50 cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary-400"></i>
                            <input id="search-overdue" value="${searchText}" class="rounded-full pl-10 pr-4 py-2 text-sm font-medium text-secondary-600 placeholder-secondary-400 bg-secondary-50 border border-secondary-200 w-64 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" type="search" placeholder="Search books or students..."/>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center py-16 text-secondary-400 border border-secondary-200 rounded-lg">
                        <i class="fas fa-search text-secondary-300 text-4xl mb-4"></i>
                        <p class="text-lg font-medium">No results found</p>
                        <p class="text-sm mt-2">No books matching "${searchText}" found</p>
                        <button onclick="clearSearch()" class="mt-4 px-4 py-2 bg-secondary-100 text-secondary-700 rounded-lg hover:bg-secondary-200 transition-colors">
                            Clear Search
                        </button>
                    </div>
                `;
                
                // Re-add event listener and restore focus
                const newSearchInput = document.getElementById('search-overdue');
                if (newSearchInput) {
                    newSearchInput.addEventListener('input', handleSearch);
                }
            } else {
                // Instead of calling renderOverdueBooks, update the table directly
                const overdueSection = document.getElementById('overdueBooks');
                const tbody = overdueSection.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = filteredBooks.map(book => {
                        const title = book.title || book.book_name || book.name || 'Unknown';
                        const studentName = book.studentName || book.student_name || 'Unknown';
                        const borrowDate = book.borrowDate || book.borrow_date || new Date().toISOString();
                        const dueDate = book.dueDate || book.due_date || new Date().toISOString();
                        
                        const dueDateObj = new Date(dueDate);
                        const borrowDateObj = new Date(borrowDate);
                        const now = new Date();
                        const daysOverdue = Math.max(0, Math.floor((now - dueDateObj) / (1000 * 60 * 60 * 24)));
                        
                        let severityClass = 'bg-yellow-50 text-yellow-800';
                        if (daysOverdue > 7) {
                            severityClass = 'bg-red-50 text-red-800';
                        } else if (daysOverdue > 3) {
                            severityClass = 'bg-orange-50 text-orange-800';
                        }
                        
                        return `
                            <tr class="hover:bg-secondary-50 transition-colors">
                                <td class="py-3 px-4 font-medium text-secondary-900">
                                    ${title}
                                </td>
                                <td class="py-3 px-4">${studentName}</td>
                                <td class="py-3 px-4 whitespace-nowrap">${formatDateOnly(borrowDateObj)}</td>
                                <td class="py-3 px-4 whitespace-nowrap">${formatDateOnly(dueDateObj)}</td>
                                <td class="py-3 px-4">
                                    <span class="inline-flex items-center justify-center px-2.5 py-1 rounded-full text-xs font-medium ${severityClass}">
                                        ${daysOverdue} days
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // Update the count display
                const countDisplay = overdueSection.querySelector('.text-xs.font-medium');
                if (countDisplay) {
                    countDisplay.textContent = `${filteredBooks.length} results`;
                }
            }
        }

        function clearSearch() {
            checkOverdueBooks();
        }

        // Helper functions for date formatting
        function formatDateOnly(dateObj) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            };
            return dateObj.toLocaleDateString('en-US', options);
        }

        function formatTimeOnly(dateObj) {
            const options = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            };
            return dateObj.toLocaleTimeString('en-US', options);
        }

        // Add these new functions for logout handling
        function showLogoutModal() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        function confirmLogout() {
            // Clear any stored user data
            localStorage.removeItem('userData');
            // Show success notification
            showModal('Logged out successfully', 'success');
            // Redirect to login page after a short delay
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }

        // Add toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = toast.querySelector('i');

            // Set message
            toastMessage.textContent = message;

            // Set icon and style based on type
            switch(type) {
                case 'success':
                    toast.className = 'toast success';
                    toastIcon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    toast.className = 'toast error';
                    toastIcon.className = 'fas fa-times-circle';
                    break;
                case 'info':
                    toast.className = 'toast info';
                    toastIcon.className = 'fas fa-info-circle';
                    break;
            }

            // Show toast
            toast.classList.add('show');

            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>