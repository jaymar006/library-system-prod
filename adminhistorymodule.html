<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="../dist/output.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../node_modules/flowbite/dist/flowbite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }

        /* Table styles */
        .history-table th {
            position: relative;
        }

        .sortable {
            cursor: pointer;
        }

        .sortable:after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #64748b;
            opacity: 0.8;
        }

        .sortable.asc:after {
            content: '↑';
            color: #64748b;
            opacity: 1;
        }

        .sortable.desc:after {
            content: '↓';
            color: #64748b;
            opacity: 1;
        }

        /* Animations */
        .animate-pulse-soft {
            animation: pulse-soft 2s infinite;
        }
        
        @keyframes pulse-soft {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }

        /* Custom styles that can't be achieved with Tailwind */
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            margin: auto;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        /* Layout styles */


        /* Main Content Styles */
        .main-content {
            padding: 1.5rem;
            width: calc(100% - 14rem);
            min-height: 100vh;
        }

        /* Table Styles */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }

        .history-table th {
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Search Bar Styles */
        .search-bar {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-bar:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        /* Message Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 400px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            cursor: pointer;
        }

        .modal-content.info {
            border-left: 5px solid #2196F3;
        }
        .modal-content.success {
            border-left: 5px solid #28a745;
        }
        .modal-content.error {
            border-left: 5px solid #dc3545;
        }

        /* Sidebar styles */
        .sidebar {
            transition: all 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 40;
            overflow-y: auto;
        }

        .sidebar:hover {
            width: 256px !important;
            min-width: 256px !important;
            max-width: 256px !important;
        }

        .sidebar:not(:hover) {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
        }

        .sidebar:not(:hover) .nav-text,
        .sidebar:not(:hover) .welcome-text,
        .sidebar:not(:hover) .footer-text {
            display: none;
        }

        .sidebar:not(:hover) .nav-icon {
            margin-right: 0;
        }

        .sidebar:not(:hover) .nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .sidebar:not(:hover) .profile-section {
            padding: 0.5rem;
        }

        .sidebar:not(:hover) .profile-image {
            width: 40px;
            height: 40px;
        }

        .sidebar:not(:hover) .footer-section {
            padding: 0.5rem;
        }

        /* Add styles for main content to account for fixed sidebar */
        main {
            transition: margin-left 0.3s ease;
            width: calc(100% - 80px);
        }

        .sidebar:hover + main {
            margin-left: 80px;
            width: calc(100% - 256px);
        }

        /* Fix icon positioning */
        .nav-item {
            display: flex;
            align-items: center;
            position: relative;
        }

        .nav-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-secondary-50 font-sans text-base text-secondary-600 relative antialiased">
    <div class="fixed top-0 right-0 z-50 flex gap-2 select-none p-2">
        <button onclick="window.electronAPI.minimize()" title="Minimize" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-blue-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 18L18 18"/></svg>
        </button>
        <button onclick="window.electronAPI.maximize()" title="Maximize/Restore" class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 active:bg-gray-300 text-gray-600 hover:text-green-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="6" y="6" width="12" height="12" rx="2" stroke-width="2"/></svg>
        </button>
        <button onclick="window.electronAPI.close()" title="Close" class="w-8 h-8 flex items-center justify-center rounded hover:bg-red-100 active:bg-red-200 text-gray-600 hover:text-red-600 transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M6 6l12 12M6 18L18 6"/></svg>
        </button>
    </div>
    <div class="flex min-h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar bg-gray-100 w-64 min-w-[256px] max-w-[256px] flex flex-col py-6 px-3 select-none shrink-0 shadow-xl z-10 border-r border-gray-200 relative">
            <div class="flex flex-col items-center space-y-3 mb-8 profile-section">
                <div class="relative group">
                    <div class="absolute inset-0 bg-primary-100 rounded-full opacity-70 blur-md transform group-hover:scale-110 transition-all duration-300"></div>
                    <div class="relative bg-white rounded-full w-16 h-16 flex items-center justify-center shadow-md profile-image">
                        <img alt="Admin" class="rounded-full w-12 h-12 object-cover" src="assets/pic/removebgroyal.png"/>
                    </div>
                </div>
                <div class="text-center welcome-text">
                    <p class="text-xs font-bold uppercase tracking-wider mb-1 text-gray-500">Welcome</p>
                    <p class="text-lg font-bold text-gray-800">ADMIN</p>
                </div>
            </div>
            
            <nav class="w-full flex flex-col space-y-1 font-medium text-sm mt-2">
                <button onclick="window.location.href='admindashboard.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-chart-line w-5 text-center nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </button>
                
                <button onclick="window.location.href='adminstudentmodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-users w-5 text-center nav-icon"></i>
                    <span class="nav-text">Students</span>
                </button>
                
                <button onclick="window.location.href='adminbookmodule.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-book w-5 text-center nav-icon"></i>
                    <span class="nav-text">Books</span>
                </button>
                
                <button id="history-menu" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg bg-primary-100 text-primary-700 font-semibold transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-history w-5 text-center nav-icon"></i>
                    <span class="nav-text">History</span>
                </button>
                
                <button onclick="window.location.href='borrowed.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-hand-holding w-5 text-center nav-icon"></i>
                    <span class="nav-text">Borrow Book</span>
                </button>
                
                <button onclick="window.location.href='returned.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-undo w-5 text-center nav-icon"></i>
                    <span class="nav-text">Return Book</span>
                </button>
                
                <button onclick="window.location.href='rewards.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-trophy w-5 text-center nav-icon"></i>
                    <span class="nav-text">Rewards</span>
                </button>

                <button onclick="window.location.href='archive.html'" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-200 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-archive w-5 text-center nav-icon"></i>
                    <span class="nav-text">Archive</span>
                </button>
                
                <div class="border-t border-gray-300 my-2 px-3"></div>
                
                <button onclick="logout()" 
                    class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-100 transform hover:translate-x-1 transition-all active:scale-95">
                    <i class="fas fa-sign-out-alt w-5 text-center nav-icon"></i>
                    <span class="nav-text">Log Out</span>
                </button>
            </nav>
            
            <div class="mt-auto px-4 py-4 footer-section">
                <div class="bg-primary-50 border border-primary-100 rounded-lg px-3 py-2 text-xs text-gray-700 footer-text">
                    <p class="mb-1 font-medium text-gray-800">Royal Heirs Academy</p>
                    <p>Library Management System</p>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-secondary-50">
            <div class="container mx-auto px-4 py-6 max-w-7xl">
                <!-- Header Section -->
                <header class="mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-secondary-900 leading-tight">
                                Borrowing History
                            </h1>
                            <p class="mt-1 text-sm text-secondary-500">View and manage library borrowing records</p>
                        </div>
                        
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <button onclick="exportToExcel()" class="px-3 py-1.5 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all flex items-center text-sm">
                                <i class="fas fa-file-excel mr-2"></i>
                                <span>Export to Excel</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Filters Section -->
                <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex flex-wrap items-center justify-between gap-3 border border-secondary-100">
                    <div class="flex flex-wrap gap-3">
                        <div class="flex items-center">
                            <label for="monthFilter" class="text-sm font-medium text-secondary-700 mr-2">Month:</label>
                            <select id="monthFilter" class="px-3 py-2 border border-secondary-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500" onchange="filterHistory()">
                                <option value="">All Months</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <label for="yearFilter" class="text-sm font-medium text-secondary-700 mr-2">Year:</label>
                            <select id="yearFilter" class="px-3 py-2 border border-secondary-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500" onchange="filterHistory()">
                                <option value="">All Years</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary-400"></i>
                        <input 
                            class="pl-10 pr-4 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500 w-64" 
                            type="text" 
                            id="historySearch" 
                            placeholder="Search students or books..." 
                            oninput="searchHistory()">
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-secondary-100">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Borrow Date</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Return Date</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Settled</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4 success">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <p id="modalMessage" class="text-lg font-semibold"></p>
            </div>
        </div>
    </div>

    <!-- Settlement Confirmation Modal -->
    <div id="settlementModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100]">
        <div class="modal-content bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-secondary-900">Confirm Settlement</h2>
                <button onclick="hideSettlementModal()" class="text-secondary-400 hover:text-secondary-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="text-center py-4">
                <i class="fas fa-question-circle text-primary-500 text-4xl mb-4"></i>
                <p class="text-lg text-secondary-700 mb-6">
                    Has this book been settled?
                </p>
                
                <div class="flex justify-center space-x-4">
                    <button id="confirmSettlement" 
                        class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
                        <i class="fas fa-check mr-2"></i>
                        <span>Yes, Settled</span>
                    </button>
                    <button id="cancelSettlement" 
                        class="px-6 py-2 bg-secondary-100 text-secondary-700 rounded-lg hover:bg-secondary-200 transition-colors flex items-center">
                        <i class="fas fa-times mr-2"></i>
                        <span>No, Not Settled</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSort = {
            column: null,
            direction: 'asc'
        };
        let currentPage = 1;
        let recordsPerPage = 5;
        let allHistoryData = []; // Store all history data

        // Function to populate year dropdown
        function populateYearDropdown() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            
            // Clear existing options except the "All Years" option
            while (yearSelect.options.length > 1) {
                yearSelect.remove(1);
            }
            
            // Add years from current year to 5 years back
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Function to filter history data
        function filterHistory() {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            let filteredData = [...allHistoryData];
            
            if (monthFilter) {
                filteredData = filteredData.filter(record => {
                    const date = new Date(record.borrow_date);
                    return (date.getMonth() + 1).toString().padStart(2, '0') === monthFilter;
                });
            }
            
            if (yearFilter) {
                filteredData = filteredData.filter(record => {
                    const date = new Date(record.borrow_date);
                    return date.getFullYear().toString() === yearFilter;
                });
            }
            
            currentPage = 1; // Reset to first page when filtering
            renderHistoryTable(filteredData);
        }

        // Function to render history table
        function renderHistoryTable(historyData) {
            const tableBody = document.getElementById('historyTableBody');
            
            // Remove any existing pagination controls
            const existingPagination = document.querySelector('.pagination-controls');
            if (existingPagination) {
                existingPagination.remove();
            }

            // Show loading indicator
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="p-4 text-center text-secondary-500">
                        <div class="py-6">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600 mb-3"></div>
                            <p class="text-sm">Loading history records...</p>
                        </div>
                    </td>
                </tr>
            `;

            // Calculate pagination values
            const totalRecords = historyData.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, totalRecords);
            const currentRecords = historyData.slice(startIndex, endIndex);

            // Create pagination controls
            const paginationControls = document.createElement('div');
            paginationControls.className = 'pagination-controls flex justify-between items-center my-4 text-sm text-secondary-600';
            paginationControls.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xs font-medium bg-primary-50 text-primary-700 px-2.5 py-1 rounded-full">
                        ${totalRecords === 0 ? '0-0' : `${startIndex + 1}-${endIndex}`} of ${totalRecords}
                    </span>
                    <button id="prev-page" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 transition-all ${currentPage === 1 ? 'opacity-50 cursor-not-allowed text-secondary-400' : 'text-secondary-700'}" ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="font-medium">Page ${currentPage} of ${totalPages || 1}</span>
                    <button id="next-page" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-secondary-100 transition-all ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed text-secondary-400' : 'text-secondary-700'}" ${currentPage >= totalPages ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div>
                    <select id="rows-per-page" class="text-sm border-secondary-200 rounded-lg focus:border-primary-500 focus:ring focus:ring-primary-200 focus:ring-opacity-50 bg-white shadow-sm">
                        <option value="5" ${recordsPerPage === 5 ? 'selected' : ''}>5 rows</option>
                        <option value="10" ${recordsPerPage === 10 ? 'selected' : ''}>10 rows</option>
                        <option value="25" ${recordsPerPage === 25 ? 'selected' : ''}>25 rows</option>
                    </select>
                </div>
            `;

            // Insert pagination controls after the table
            const table = document.querySelector(".bg-white.rounded-lg.shadow-sm");
            table.insertAdjacentElement('afterend', paginationControls);

            // Clear the table body
            tableBody.innerHTML = "";

            // Render the current page of records
            if (currentRecords.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="text-center py-4 text-gray-500">
                        No history records available.
                    </td>
                `;
                tableBody.appendChild(emptyRow);
            } else {
                currentRecords.forEach((record) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50";
                    
                    // Format dates to AM/PM format
                    const borrowDate = new Date(record.borrow_date);
                    const dueDate = new Date(record.due_date);
                    const returnDate = record.return_date ? new Date(record.return_date) : null;

                    const formattedBorrowDate = borrowDate.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    const formattedDueDate = dueDate.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    const formattedReturnDate = returnDate 
                        ? returnDate.toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                        : "Not returned";

                    // Determine status badge color
                    let statusClass = '';
                    switch (record.status.toLowerCase()) {
                        case 'borrowed':
                            statusClass = 'bg-blue-100 text-blue-800';
                            break;
                        case 'returned':
                            statusClass = 'bg-green-100 text-green-800';
                            break;
                        case 'return w/ damage':
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            break;
                        case 'lost':
                            statusClass = 'bg-red-100 text-red-800';
                            break;
                        default:
                            statusClass = 'bg-gray-100 text-gray-800';
                    }

                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap border-b">${record.student_name}</td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">${record.book_name}</td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">${formattedBorrowDate}</td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">${formattedDueDate}</td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">${formattedReturnDate}</td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${record.status}
                            </span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap border-b">
                            ${getSettlementButton(record)}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Add event listeners for pagination buttons
            document.getElementById('prev-page')?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderHistoryTable(historyData);
                }
            });

            document.getElementById('next-page')?.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderHistoryTable(historyData);
                }
            });

            // Add event listener for rows per page selector
            document.getElementById('rows-per-page')?.addEventListener('change', (e) => {
                recordsPerPage = parseInt(e.target.value);
                currentPage = 1; // Reset to first page
                renderHistoryTable(historyData);
            });

            // Add event listeners for sortable headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                    
                    // Remove sort classes from all headers
                    document.querySelectorAll('.sortable').forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    
                    // Add sort class to current header
                    header.classList.add(direction);
                    
                    currentSort = { column, direction };
                    sortTable(column, direction);
                });
            });
        }

        // Function to fetch history
        async function fetchHistory() {
            try {
                // Show loading state
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600 mb-4"></div>
                            <p>Loading history records...</p>
                        </td>
                    </tr>
                `;
                
                const result = await window.electronAPI.getHistory();
                if (result.success) {
                    allHistoryData = result.history || []; // Store all history data, default to empty array if null
                    renderHistoryTable(allHistoryData);
                    populateYearDropdown();
                    
                    // Set up an interval to check for year changes
                    setInterval(() => {
                        const currentYear = new Date().getFullYear();
                        const yearSelect = document.getElementById('yearFilter');
                        const lastOption = yearSelect.options[yearSelect.options.length - 1];
                        if (parseInt(lastOption.value) < currentYear) {
                            populateYearDropdown();
                        }
                    }, 60000); // Check every minute
                } else {
                    console.error("Error fetching history:", result.error);
                    showModal('Error fetching history data', 'error');
                    
                    // Show error in table
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8">
                                <i class="fas fa-exclamation-circle text-gray-500 text-4xl mb-4"></i>
                                <p class="text-lg font-medium">Error loading history data</p>
                                <p class="text-sm mt-2">Please try refreshing the page</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error("Error fetching history:", error);
                showModal('Error fetching history data: ' + error.message, 'error');
                
                // Show error in table
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8">
                            <i class="fas fa-exclamation-circle text-gray-500 text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Error loading history data</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Function to search history
        function searchHistory() {
            const searchText = document.getElementById('historySearch').value.toLowerCase();
            currentPage = 1; // Reset to first page when searching
            
            try {
                let filteredData = allHistoryData.filter(record => {
                    return (
                        (record.student_name?.toLowerCase() || '').includes(searchText) ||
                        (record.book_name?.toLowerCase() || '').includes(searchText) ||
                        (record.status?.toLowerCase() || '').includes(searchText)
                    );
                });
                
                renderHistoryTable(filteredData);
            } catch (error) {
                console.error("Error during search:", error);
                showModal('Error during search', 'error');
            }
        }

        // Function to sort table
        function sortTable(column, direction) {
            const tbody = document.querySelector('.history-table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Remove sort classes from all headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            // Add sort class to current header
            const header = document.querySelector(`[data-sort="${column}"]`);
            header.classList.add(direction);
            
            // Sort the rows
            rows.sort((a, b) => {
                let aValue = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;
                let bValue = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;
                
                // Handle date values
                if (['borrow_date', 'return_date'].includes(column)) {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                // Handle null/empty values
                if (aValue === 'Not returned' || aValue === '') aValue = direction === 'asc' ? 'zzz' : '';
                if (bValue === 'Not returned' || bValue === '') bValue = direction === 'asc' ? 'zzz' : '';
                
                // Compare values
                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Reorder the rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Helper function to get column index
        function getColumnIndex(column) {
            const headers = document.querySelectorAll('.history-table th');
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].dataset.sort === column) {
                    return i + 1;
                }
            }
            return 1;
        }

        // Function to show modal messages
        function showModal(message, type = 'info') {
            const modal = document.getElementById('messageModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalMessage = document.getElementById('modalMessage');
            const iconElement = modalContent.querySelector('i');
            
            // Remove existing types and add new one
            modalContent.classList.remove('success', 'error', 'info', 'warning');
            modalContent.classList.add(type);
            
            // Update icon based on type
            iconElement.className = ''; // Clear existing classes
            
            switch(type) {
                case 'success':
                    iconElement.className = 'fas fa-check-circle text-green-500 text-4xl mb-4';
                    break;
                case 'error':
                    iconElement.className = 'fas fa-times-circle text-gray-500 text-4xl mb-4';
                    break;
                case 'info':
                    iconElement.className = 'fas fa-info-circle text-blue-500 text-4xl mb-4';
                    break;
                case 'warning':
                    iconElement.className = 'fas fa-exclamation-triangle text-amber-500 text-4xl mb-4';
                    break;
                default:
                    iconElement.className = 'fas fa-info-circle text-blue-500 text-4xl mb-4';
            }
            
            modalMessage.textContent = message;
            modal.style.display = 'flex';
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 3000);
        }

        // Function to export to Excel
        async function exportToExcel() {
            try {
                const monthFilter = document.getElementById('monthFilter').value;
                const yearFilter = document.getElementById('yearFilter').value;
                
                let filteredData = [...allHistoryData];
                
                if (monthFilter) {
                    filteredData = filteredData.filter(record => {
                        const date = new Date(record.borrow_date);
                        return (date.getMonth() + 1).toString().padStart(2, '0') === monthFilter;
                    });
                }
                
                if (yearFilter) {
                    filteredData = filteredData.filter(record => {
                        const date = new Date(record.borrow_date);
                        return date.getFullYear().toString() === yearFilter;
                    });
                }

                if (filteredData.length === 0) {
                    showModal('No history data to export for the selected period.', 'error');
                    return;
                }

                showModal('Preparing Excel file...', 'info');

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('History');

                worksheet.columns = [
                    { header: 'Student Name', key: 'student_name', width: 20 },
                    { header: 'Book Name', key: 'book_name', width: 30 },
                    { header: 'Borrow Date', key: 'borrow_date', width: 20 },
                    { header: 'Return Date', key: 'return_date', width: 20 },
                    { header: 'Status', key: 'status', width: 15 }
                ];

                // Format dates to AM/PM format
                filteredData.forEach(record => {
                    const borrowDate = new Date(record.borrow_date);
                    const returnDate = record.return_date ? new Date(record.return_date) : null;

                    const formattedBorrowDate = borrowDate.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    const formattedReturnDate = returnDate 
                        ? returnDate.toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                        : 'Not returned';

                    worksheet.addRow({
                        student_name: record.student_name,
                        book_name: record.book_name,
                        borrow_date: formattedBorrowDate,
                        return_date: formattedReturnDate,
                        status: record.status
                    });
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Set filename based on filters
                let filename = 'borrowing_history';
                if (monthFilter) {
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    filename += `_${monthNames[parseInt(monthFilter) - 1]}`;
                }
                if (yearFilter) {
                    filename += `_${yearFilter}`;
                }
                filename += '.xlsx';
                
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                showModal('Excel file generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating Excel file:', error);
                showModal('Error generating Excel file: ' + error.message, 'error');
            }
        }

        // Function to logout
        function logout() {
            // Clear any stored user data
            localStorage.removeItem('userData');
            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Event listeners
        window.onclick = function(event) {
            const messageModal = document.getElementById('messageModal');
            if (event.target === messageModal) {
                messageModal.style.display = 'none';
            }
        }

        // Add event listeners for settlement modal
        document.addEventListener('DOMContentLoaded', function() {
            const confirmSettlementBtn = document.getElementById('confirmSettlement');
            const cancelSettlementBtn = document.getElementById('cancelSettlement');
            const settlementModal = document.getElementById('settlementModal');

            if (confirmSettlementBtn) {
                confirmSettlementBtn.addEventListener('click', () => {
                    updateSettlementStatus(true);
                });
            }

            if (cancelSettlementBtn) {
                cancelSettlementBtn.addEventListener('click', () => {
                    updateSettlementStatus(false);
                });
            }

            if (settlementModal) {
                settlementModal.addEventListener('click', (e) => {
                    if (e.target === settlementModal) {
                        hideSettlementModal();
                    }
                });
            }
        });

        // Initialize the page
        window.onload = function() {
            fetchHistory();
            
            // Add click event listeners to sortable headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                    
                    // Remove sort classes from all headers
                    document.querySelectorAll('.sortable').forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    
                    // Add sort class to current header
                    header.classList.add(direction);
                    
                    currentSort = { column, direction };
                    sortTable(column, direction);
                });
            });
        };

        function getSettlementButton(record) {
            if (record.status.toLowerCase() === 'returned') {
                return '<span class="text-green-600"><i class="fas fa-check-circle"></i></span>';
            } else if (record.status.toLowerCase() === 'return w/ damage' || record.status.toLowerCase() === 'lost') {
                const buttonClass = record.settled ? 'text-green-600 cursor-not-allowed' : 'text-yellow-500 hover:text-yellow-600';
                const iconClass = record.settled ? 'fas fa-check-circle' : 'fas fa-check';
                return record.settled ? 
                    '<span class="text-green-600"><i class="fas fa-check-circle"></i></span>' :
                    `<button onclick="showSettlementModal(${record.borrow_id}, ${record.settled})" 
                        class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200 ${buttonClass}">
                        <i class="${iconClass}"></i>
                        </button>`;
            }
            return '-';
        }

        let currentBorrowingId = null;
        let currentSettledStatus = null;

        function showSettlementModal(borrowingId, currentStatus) {
            currentBorrowingId = borrowingId;
            currentSettledStatus = currentStatus;
            const modal = document.getElementById('settlementModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function hideSettlementModal() {
            const modal = document.getElementById('settlementModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            currentBorrowingId = null;
            currentSettledStatus = null;
        }

        async function updateSettlementStatus(settled) {
            if (!currentBorrowingId) {
                showModal('No borrowing record selected', 'error');
                return;
            }

            try {
                const response = await window.electronAPI.updateSettlement({
                    borrowingId: currentBorrowingId,
                    settled: settled
                });

                if (response.success) {
                    // Update the UI to reflect the new settlement status
                    const button = document.querySelector(`button[onclick="showSettlementModal(${currentBorrowingId}, ${currentSettledStatus})"]`);
                    if (button) {
                        const newStatus = settled;
                        const buttonClass = newStatus ? 'text-green-600' : 'text-yellow-500 hover:text-yellow-600';
                        const iconClass = newStatus ? 'fas fa-check-circle' : 'fas fa-check';
                        button.className = `p-2 rounded-full hover:bg-gray-100 transition-colors duration-200 ${buttonClass}`;
                        button.innerHTML = `<i class="${iconClass}"></i>`;
                        button.setAttribute('onclick', `showSettlementModal(${currentBorrowingId}, ${newStatus})`);
                    }
                    hideSettlementModal();
                    showModal('Settlement status updated successfully', 'success');
                    // Refresh the history data
                    await fetchHistory();
                } else {
                    showModal(response.error || 'Failed to update settlement status', 'error');
                }
            } catch (error) {
                console.error('Error updating settlement:', error);
                showModal('Failed to update settlement status: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 